<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />

  <script>
    // Early language hint to reduce initial relayout (safe even before full i18n init)
    (function () {
      try {
        const key = 'eatlog_lang';
        const saved = localStorage.getItem(key);
        const deviceLang = (navigator.languages && navigator.languages[0]) ? navigator.languages[0] : (navigator.language || 'en');
        const detected = /^ru/i.test(deviceLang) ? 'ru' : 'en';
        const lang = saved || detected;
        document.documentElement.lang = lang;
      } catch (e) {}
    })();
  </script>

  <meta name="google-site-verification" content="DIEjG1KJAKMRZcO0IhGHHjHVpjYuYUvos7rULW_0690" />
  <title>EatLog ‚Äî —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏, –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–µ—Ä–µ–∫—É—Å–æ–≤</title>

  <meta name="description"
    content="EatLog ‚Äî –ø—Ä–æ—Å—Ç–æ–π —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ –∏ –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è. –ü–æ–º–æ–≥–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∫—É—Å—ã, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –µ–¥–æ–π. –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ–ª–∞–π–Ω, –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏." />

  <meta name="keywords"
    content="EatLog, —Ç—Ä–µ–∫–µ—Ä –ø–∏—Ç–∞–Ω–∏—è, –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è, —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–µ—Ä–µ–∫—É—Å–æ–≤, –ø–µ—Ä–µ–∫—É—Å—ã, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –º–µ–∂–¥—É –µ–¥–æ–π, –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ" />

  <meta name="author" content="EatLog" />

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />


  <link rel="canonical" href="https://albinaushakova.github.io/self-control-trackers/meal-tracker/" />
  <meta property="og:title" content="EatLog ‚Äî —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–µ—Ä–µ–∫—É—Å–æ–≤" />
  <meta property="og:description"
    content="–ü—Ä–æ—Å—Ç–æ–π –¥–Ω–µ–≤–Ω–∏–∫ –ø–∏—Ç–∞–Ω–∏—è: –ø—Ä–∏–µ–º—ã –ø–∏—â–∏, –ø–µ—Ä–µ–∫—É—Å—ã, –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞. –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://albinaushakova.github.io/self-control-trackers/meal-tracker/" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#020617" />

  <!-- iOS (Add to Home Screen) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="EatLog" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-167.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-120.png" />
  <!-- iOS Startup images (splash) -->
  <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="startup/apple-launch-750x1334.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="startup/apple-launch-1242x2208.png">
  <link rel="apple-touch-startup-image" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="startup/apple-launch-1125x2436.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="startup/apple-launch-828x1792.png">
  <link rel="apple-touch-startup-image" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="startup/apple-launch-1242x2688.png">
  <link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="startup/apple-launch-1170x2532.png">
  <link rel="apple-touch-startup-image" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="startup/apple-launch-1284x2778.png">
  <link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="startup/apple-launch-1179x2556.png">
  <link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)" href="startup/apple-launch-1290x2796.png">
  <link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="startup/apple-launch-1536x2048.png">
  <link rel="apple-touch-startup-image" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="startup/apple-launch-2048x1536.png">
  <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="startup/apple-launch-1668x2224.png">
  <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="startup/apple-launch-2224x1668.png">
  <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="startup/apple-launch-1668x2388.png">
  <link rel="apple-touch-startup-image" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="startup/apple-launch-2388x1668.png">
  <link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)" href="startup/apple-launch-2048x2732.png">
  <link rel="apple-touch-startup-image" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)" href="startup/apple-launch-2732x2048.png">


  <!-- Android / Chrome -->
  <meta name="mobile-web-app-capable" content="yes" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png" />
  <style>
    /* Critical: prevent white flash before CSS/JS paint */
    html, body { background: #020617; }
  </style>

  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #020617 0, #020617 55%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px 12px;
      text-align: left;
    }
    /* –≤—Å—ë —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é, –¥–∞–∂–µ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–∞—Å–ª–µ–¥–æ–≤–∞–ª–æ —Ü–µ–Ω—Ç—Ä */
    h1,
    h2,
    p,
    label,
    .subtle,
    .card,
    .card *,
    .stats-grid,
    .stats-grid *,
    .history-wrapper,
    .history-wrapper *,
    .period-controls,
    .period-controls *,
    .list,
    .list *,
    .meal-row,
    .meal-row *,
    .goal-row,
    .goal-row *,
    table,
    table * {
      text-align: left !important;
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      border-radius: 28px;
      padding: 14px 14px 20px;
      background: rgba(15, 23, 42, 0.96);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      display: flex;
      flex-direction: column;
      max-height: 100%;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.02em;
    }

    .subtle {
      font-size: 12px;
      color: #9ca3af;
      margin: 4px 2px 10px;
    }

    /* –í–∫–ª–∞–¥–∫–∏ */
    .view-tabs-wrapper {
      margin: 4px 0 10px;
    }

    .view-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
    }

    .tab-btn {
      flex: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.15s ease, color 0.15s ease, transform 0.08s ease;
    }

    .tab-btn.active {
      background: #e5e7eb;
      color: #020617;
      transform: translateY(-1px);
    }

    .app-content {
      flex: 1;
      overflow-y: auto;
      padding-right: 2px;
      padding-bottom: 8px;
      margin-top: 2px;
    }

    h2 {
      font-size: 17px;
      margin-top: 0;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      padding: 12px 12px 10px;
      margin-bottom: 10px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45);
      border: none;
    }

    .card-compact {
      padding-top: 10px;
      padding-bottom: 10px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 9px 11px;
      font-size: 14px;
      margin-bottom: 10px;
      resize: vertical;
      min-height: 52px;
      outline: none;
      transition: border-color 0.12s ease, background 0.12s ease;
    }

    textarea:focus {
      border-color: #22c55e;
      background: #020617;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 6px;
      margin-top: 4px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.15s ease, transform 0.08s ease;
      white-space: nowrap;
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      width: 100%;
      box-shadow: none;
    }

    .btn-primary:hover {
      background: #16a34a;
    }

    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .btn-outline:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .btn-danger {
      background: transparent;
      color: #fca5a5;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: rgba(127, 29, 29, 0.3);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
    }

    .btn-ghost:hover {
      background: rgba(31, 41, 55, 1);
    }

    .list {
      max-height: 360px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .meal-row {
      border-bottom: 1px solid #111827;
      padding: 7px 0;
      font-size: 14px;
    }

    .meal-row:last-child {
      border-bottom: none;
    }

    .row-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .actions {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .meal-time {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      font-size: 14px;
    }

    .meal-note {
      color: #e5e7eb;
      word-break: break-word;
      font-size: 13px;
    }

    .meal-interval {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .stat-box {
      background: #020617;
      border-radius: 12px;
      padding: 8px 9px;
      font-size: 13px;
      border: none;
      box-shadow: none;
      min-height: 52px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: flex-start;
    }

    .stat-label {
      color: #9ca3af;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    .history-wrapper {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 12px;
      margin-top: 4px;
      background: #020617;
    }

    /* –¢–ê–ë–õ–ò–¶–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 12px;
      background: transparent;
    }

    th,
    td {
      padding: 8px 4px;
      border-bottom: 1px solid #111827;
      vertical-align: middle;
    }

    /* –±–æ–ª–µ–µ —É–¥–æ–±–Ω—ã–µ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ */
    th:nth-child(1),
    td:nth-child(1) {
      /* –¥–∞—Ç–∞ ‚Äî –º–µ–Ω—å—à–µ, –º–µ—Å—Ç–∞ –µ–π –º–Ω–æ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ */
      width: 14%;
    }

    th:nth-child(2),
    td:nth-child(2) {
      width: 17%;
    }

    th:nth-child(3),
    td:nth-child(3) {
      /* –ø–µ—Ä–µ–∫—É—Å—ã ‚Äî —à–∏—Ä–µ, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–∞ "–ü–ï–†–ï–ö–£–°–´" */
      width: 22%;
    }

    th:nth-child(4) {
      width: 23%;
      white-space: pre-line;
      /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è */
      overflow-wrap: anywhere;
      word-break: break-word;
      hyphens: auto;
    }

    td:nth-child(4) {
      width: 23%;
      white-space: nowrap;
      /* –∑–Ω–∞—á–µ–Ω–∏—è –≤—Ä–æ–¥–µ "13 —á 58 –º–∏–Ω" –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º */
    }

    th:nth-child(5) {
      width: 24%;
      white-space: pre-line;
      /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å—Å—è */
      overflow-wrap: anywhere;
      word-break: break-word;
      hyphens: auto;
    }

    td:nth-child(5) {
      width: 24%;
      white-space: nowrap;
      /* –∑–Ω–∞—á–µ–Ω–∏—è –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
    }

    th {
      /* –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Å—Ç–æ–ª–±—Ü–æ–≤ –¥–æ–ª–∂–Ω—ã –≤–ª–µ–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é (–∏ –Ω–∞ RU, –∏ –Ω–∞ EN) */
      font-size: 10px;
      color: #9ca3af;
      font-weight: 500;
      /* uppercase —Å–∏–ª—å–Ω–æ ¬´—Ä–∞–∑–¥—É–≤–∞–µ—Ç¬ª —à–∏—Ä–∏–Ω—É –∏ —á–∞—Å—Ç–æ –æ–±—Ä–µ–∑–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∏ */
      text-transform: none;
      letter-spacing: 0.02em;
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
      white-space: pre-line;
      line-height: 1.15;
      overflow-wrap: anywhere;
      word-break: break-word;
      hyphens: auto;
    }

    /* –Ω–∞ –æ—á–µ–Ω—å —É–∑–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –¥–µ–ª–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ */
    @media (max-width: 380px) {
      th {
        font-size: 9px;
        letter-spacing: 0.01em;
        padding-top: 6px;
        padding-bottom: 6px;
      }
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr {
      transition: background 0.12s ease;
    }

    tbody tr:hover {
      background: #020617;
    }

    /* –ü–µ—Ä–∏–æ–¥ */
    .period-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 6px 0 6px;
    }

    .period-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    .period-btn.active {
      background: #e5e7eb;
      color: #020617;
      border-color: transparent;
    }

    .goal-row {
      margin-bottom: 9px;
      font-size: 13px;
    }

    .goal-row span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    input[type="number"] {
      width: 72px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 4px 6px;
      font-size: 13px;
      outline: none;
      transition: border-color 0.12s ease;
    }

    input[type="number"]:focus {
      border-color: #22c55e;
    }

    .day-ok td {
      background: rgba(22, 163, 74, 0.22);
    }

    .app-footer {
      margin-top: 4px;
      font-size: 10px;
      color: #6b7280;
    }

    /* FULLSCREEN DETAIL */
    #detailScreen {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: #020617;
      z-index: 200;
      padding: 16px;
      overflow-y: auto;
    }

    #btnDetailBack {
      background: none;
      border: none;
      color: #e5e7eb;
      font-size: 18px;
      margin-bottom: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #detailTitle {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }

    @media (max-width: 480px) {
      .app-shell {
        border-radius: 24px;
        padding-inline: 12px;
      }
    }

    /* Save goals button feedback */
    .savebtn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      overflow: hidden;
      transition: transform .12s ease, filter .2s ease;
      min-height: 38px;
    }

    .savebtn:active {
      transform: scale(.98);
    }

    .savebtn.is-saving,
    .savebtn.is-saved {
      pointer-events: none;
      filter: saturate(.92) brightness(.98);
    }

    .savebtn__spinner {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      display: none;
      animation: savebtnspin .8s linear infinite;
      opacity: .9;
    }

    .savebtn__check {
      display: none;
      font-weight: 800;
      transform: translateY(1px);
    }

    .savebtn.is-saving .savebtn__spinner {
      display: inline-block;
    }

    .savebtn.is-saved .savebtn__check {
      display: inline-block;
    }

    @keyframes savebtnspin {
      to {
        transform: rotate(360deg);
      }
    }



    /* Export button feedback */
    .exportbtn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      overflow: hidden;
      transition: transform .12s ease, filter .2s ease;
      min-height: 38px;
      width: 100%;
    }

    .exportbtn:active {
      transform: scale(.98);
    }

    .exportbtn.is-saving,
    .exportbtn.is-saved {
      pointer-events: none;
      filter: saturate(.92) brightness(.98);
    }

    .exportbtn__spinner {
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      display: none;
      animation: exportbtnspin .8s linear infinite;
      opacity: .9;
    }

    .exportbtn__check {
      display: none;
      font-weight: 800;
      transform: translateY(1px);
    }

    .exportbtn.is-saving .exportbtn__spinner {
      display: inline-block;
    }

    .exportbtn.is-saved .exportbtn__check {
      display: inline-block;
    }

    @keyframes exportbtnspin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Native-like splash overlay */
    #splash {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: radial-gradient(circle at top, #020617 0, #020617 55%, #000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      transition: opacity .22s ease, transform .22s ease;
      opacity: 1;
    }
    #splash.is-hiding {
      opacity: 0;
      transform: scale(1.01);
      pointer-events: none;
    }
    .splash-card {
      width: 100%;
      max-width: 420px;
      border-radius: 28px;
      background: rgba(15, 23, 42, 0.96);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 22px 18px 18px;
      text-align: center;
    }
    .splash-logo {
      width: 78px;
      height: 78px;
      border-radius: 20px;
      margin: 0 auto 12px;
      display: grid;
      place-items: center;
      background: rgba(2, 6, 23, 0.85);
      border: 1px solid rgba(31, 41, 55, 0.9);
      overflow: hidden;
    }
    .splash-logo img {
      width: 56px;
      height: 56px;
      object-fit: contain;
      display: block;
    }
    .splash-title {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.02em;
      color: #e5e7eb;
    }
    .splash-sub {
      margin: 6px 0 14px;
      font-size: 12px;
      color: #9ca3af;
    }
    .splash-spinner {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(229, 231, 235, 0.85);
      border-top-color: transparent;
      margin: 0 auto;
      animation: splashspin .8s linear infinite;
      opacity: .9;
    }
    @keyframes splashspin { to { transform: rotate(360deg); } }

    /* Slightly more native scrolling on iOS */
    .app-content {
      -webkit-overflow-scrolling: touch;
    }

  </style>
</head>

<body>

  <!-- Native-like splash overlay (removed after first paint) -->
  <div id="splash" aria-hidden="true">
    <div class="splash-card">
      <div class="splash-logo">
        <!-- reuse icon if available -->
        <img src="icons/icon-192.png" alt="EatLog" onerror="this.style.display='none'">
      </div>
      <h1 class="splash-title">EatLog</h1>
      <div class="splash-sub">Loading‚Ä¶</div>
      <div class="splash-spinner" aria-hidden="true"></div>
    </div>
  </div>

  <div class="app-shell">
    <header class="app-header">
      <div>
        <h1>EatLog</h1>
      </div>
      <!-- language switch -->
      <div style="display:flex; gap:6px; align-items:center;">
        <button id="langToggleBtn" class="tab-btn" style="padding:6px 10px;" aria-label="Switch language">EN</button>
      </div>
    </header>

    <div class="view-tabs-wrapper">
      <div class="view-tabs">
        <button id="tabToday" class="tab-btn active" data-i18n="tab.today">–°–µ–≥–æ–¥–Ω—è</button>
        <button id="tabStats" class="tab-btn" data-i18n="tab.stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button id="tabGoals" class="tab-btn" data-i18n="tab.goals">–¶–µ–ª–∏</button>
      </div>
    </div>

    <div class="app-content">
      <!-- –°–ï–ì–û–î–ù–Ø -->
      <div id="view-today">
        <div class="card">
          <h2 data-i18n="h.newMeal">–ù–æ–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏</h2>
          <textarea id="mealNote" data-i18n-placeholder="textarea.placeholder"
            placeholder="–æ–≤—Å—è–Ω–∫–∞, 2 –≤–∞—Ä—ë–Ω—ã—Ö —è–π—Ü–∞, –∫–æ—Ñ–µ —Å –ø–µ—á–µ–Ω—å–µ–º"></textarea>
          <button id="addMealBtn" class="btn-primary">
            <span id="addMealMain" data-i18n="btn.eating">–Ø –µ–º —Å–µ–π—á–∞—Å</span>
            <span id="addMealSub" data-i18n="btn.eatingSub">üçΩ –∏–ª–∏ üç™</span>
          </button>
          <p class="subtle" id="lastMealInfo"></p>
        </div>

        <div class="card card-compact">
          <h2 data-i18n="stats.today">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label" data-i18n="stat.meals">–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</div>
              <div class="stat-value" id="statMealsToday">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label" data-i18n="stat.snacks">–ü–µ—Ä–µ–∫—É—Å—ã</div>
              <div class="stat-value" id="statSnacksToday">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label" data-i18n="stat.dayInterval">–î–Ω–µ–≤–Ω–æ–π <br> –∏–Ω—Ç–µ—Ä–≤–∞–ª</div>
              <div class="stat-value" id="statAvgInterval">‚Äì</div>
            </div>
            <div class="stat-box">
              <div class="stat-label" data-i18n="stat.sinceLast">–° –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ <br> –ø—Ä–∏—ë–º–∞</div>
              <div class="stat-value" id="statSinceLast">‚Äì</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h2 data-i18n="today.list">–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏</h2>
          <div class="list" id="mealList"></div>
        </div>
      </div>

      <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
      <div id="view-stats" style="display: none;">
        <div class="card">
          <h2 data-i18n="period.stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</h2>
          <div class="period-controls">
            <button class="btn-outline period-btn" data-period="7" data-i18n="period.7">7 –¥–Ω–µ–π</button>
            <button class="btn-outline period-btn" data-period="14" data-i18n="period.14">14 –¥–Ω–µ–π</button>
            <button class="btn-outline period-btn" data-period="21" data-i18n="period.21">21 –¥–µ–Ω—å</button>
            <button class="btn-outline period-btn active" data-period="all" data-i18n="period.all">All</button>
          </div>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label" data-i18n="stat.meals">–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</div>
              <div class="stat-value" id="statPeriodMealsPerDay">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label" data-i18n="stat.snacks">–ò–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤</div>
              <div class="stat-value" id="statPeriodSnacksPerDay">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label" data-i18n="stat.sleep">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–Ω–∞</div>
              <div class="stat-value" id="statPeriodSleepInterval">‚Äì</div>
            </div>
            <div class="stat-box">
              <div class="stat-label" data-i18n="stat.dayInterval">–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏</div>
              <div class="stat-value" id="statPeriodAvgInterval">‚Äì</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 data-i18n="daily.breakdown">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –¥–Ω—è–º</h2>
          <div class="history-wrapper">
            <table>
              <thead>
                <tr>
                  <th data-i18n="table.date">–î–∞—Ç–∞</th>
                  <th data-i18n="table.meals">–ü—Ä–∏—ë–º—ã –ø–∏—â–∏</th>
                  <th data-i18n="table.snacks">–ü–µ—Ä–µ–∫—É—Å—ã</th>
                  <th data-i18n="table.sleep">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–Ω–∞</th>
                  <th data-i18n="table.dayInterval">–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>

          <!-- –ö–ù–û–ü–ö–ê –í–´–ì–†–£–ó–ö–ò CSV -->
          <button id="exportMealsBtn" class="btn-outline exportbtn" style="margin-top: 8px; width: 100%">
            <span class="exportbtn__label" data-i18n="export.btn" data-default-key="export.btn">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
            <span class="exportbtn__spinner" aria-hidden="true"></span>
            <span class="exportbtn__check" aria-hidden="true">‚úì</span>
          </button>
          <div class="subtle" id="exportHint" style="margin-top:6px;" data-i18n="export.hint">–§–∞–π–ª –¥–ª—è Excel/—Ç–∞–±–ª–∏—Ü
            (.csv)</div>
        </div>
      </div>

      <!-- –¶–ï–õ–ò -->
      <div id="view-goals" style="display: none;">
        <div class="card">
          <h2 data-i18n="goals.title">–¶–µ–ª–∏ –Ω–∞ –¥–µ–Ω—å</h2>
          <p class="subtle">
            <span data-i18n="goals.desc">–î–Ω–∏, –∫–æ–≥–¥–∞ —Ü–µ–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –±—É–¥—É—Ç –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å—Å—è –∑–µ–ª—ë–Ω—ã–º –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ.</span>
          </p>

          <div class="goal-row">
            <div class="subtle" data-i18n="goals.mealsLabel">–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –≤ –¥–µ–Ω—å</div>
            <span>
              <span data-i18n="range.from">–æ—Ç</span> <input type="number" id="goalMealsMin" min="0" step="1" />
              <span data-i18n="range.to">–¥–æ</span> <input type="number" id="goalMealsMax" min="0" step="1" />
            </span>
          </div>

          <div class="goal-row">
            <div class="subtle" data-i18n="goals.snacksLabel">–ò–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤ –≤ –¥–µ–Ω—å (–º–∞–∫—Å–∏–º—É–º)</div>
            <span>
              <span data-i18n="range.to">–¥–æ</span> <input type="number" id="goalSnacksMax" min="0" step="1" />
            </span>
          </div>

          <div class="goal-row">
            <div class="subtle" data-i18n="goals.sleepLabel">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–Ω–∞ (—á–∞—Å—ã, –º–µ–∂–¥—É –ø–æ—Å–ª–µ–¥–Ω–∏–º –ø—Ä–∏—ë–º–æ–º –ø–∏—â–∏ –≤—á–µ—Ä–∞ –∏
              –ø–µ—Ä–≤—ã–º —Å–µ–≥–æ–¥–Ω—è)</div>
            <span>
              <span data-i18n="range.from">–æ—Ç</span> <input type="number" id="goalSleepMin" min="0" step="0.5" />
              <span data-i18n="range.to">–¥–æ</span> <input type="number" id="goalSleepMax" min="0" step="0.5" />
            </span>
          </div>

          <div class="goal-row">
            <div class="subtle" data-i18n="goals.dayIntervalLabel">–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –ø–∏—â–∏ (—á–∞—Å—ã, –≤ —Å—Ä–µ–¥–Ω–µ–º
              –∑–∞ –¥–µ–Ω—å)</div>
            <span>
              <span data-i18n="range.from">–æ—Ç</span> <input type="number" id="goalDayIntMin" min="0" step="0.25" />
              <span data-i18n="range.to">–¥–æ</span> <input type="number" id="goalDayIntMax" min="0" step="0.25" />
            </span>
          </div>

          <button id="saveGoalsBtn" class="btn-outline savebtn">
            <span class="savebtn__label" data-i18n="goals.save" data-default-key="goals.save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª–∏</span>
            <span class="savebtn__spinner" aria-hidden="true"></span>
            <span class="savebtn__check" aria-hidden="true">‚úì</span>
          </button>
        </div>
      </div>
    </div>

    <footer class="app-footer" data-i18n="footer">EatLog ¬∑ –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∫ –±–æ–ª–µ–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–º—É –ø–∏—Ç–∞–Ω–∏—é</footer>
  </div>

  <!-- FULLSCREEN –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –î–ù–Ø -->
  <div id="detailScreen">
    <button id="btnDetailBack">
      <span data-i18n="detail.back">‚Üê –ù–∞–∑–∞–¥</span>
    </button>
    <h2 id="detailTitle"></h2>
    <div id="detailContent"></div>
  </div>
  </div>


  <script>
    // Service Worker (offline) ‚Äî works only over https or http://localhost (not file://)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => { });
      });
    }
  </script>

  <script>
    // --- i18n support ---
    const LANG_KEY = 'eatlog_lang';
    const savedLang = localStorage.getItem(LANG_KEY);
    const deviceLang = (navigator.languages && navigator.languages[0]) ? navigator.languages[0] : (navigator.language || 'en');
    const detectedLang = /^ru/i.test(deviceLang) ? 'ru' : 'en';
    const defaultLang = savedLang || detectedLang;
    const translations = {
      en: {
        "tab.today": "Today",
        "tab.stats": "Statistics",
        "tab.goals": "Goals",
        "h.newMeal": "New meal",
        "textarea.placeholder": "oatmeal, 2 boiled eggs, coffee with cookies",
        "btn.eating": "I'm eating now",
        "btn.eatingSub": "üçΩ / üç™",
        "stats.today": "Today's stats",
        "today.list": "Today's meals",
        "stat.meals": "Meals",
        "stat.snacks": "Snacks included",
        "stat.dayInterval": "Eating interval",
        "stat.sinceLast": "Since last meal",
        "list.empty": "No meals recorded yet.\nTap \"I'm eating now\" when you eat.\nUse the plate icon to mark a snack.",
        "period.stats": "Period stats",
        "daily.breakdown": "Daily breakdown",
        "stat.sleep": "Sleep interval",
        "table.date": "Date",
        "table.meals": "Meals",
        "table.snacks": "Snacks\nincluded",
        "table.sleep": "Sleep\ninterval",
        "table.dayInterval": "Eating\ninterval",
        "export.btn": "‚¨áÔ∏è Download data",
        "export.hint": "For Excel/spreadsheets (.csv)",
        "export.downloading": "Preparing file‚Ä¶",
        "export.done": "File ready",
        "period.7": "7 days",
        "period.14": "14 days",
        "period.21": "21 days",
        "period.all": "All",
        "goals.title": "Daily goals",
        "goals.desc": "Days that meet your goals will be highlighted in green in statistics.",
        "goals.mealsLabel": "Meals per day",
        "goals.snacksLabel": "Max snacks per day",
        "goals.sleepLabel": "Sleep interval (hours)",
        "goals.dayIntervalLabel": "Eating interval (hours)",
        "range.from": "from",
        "range.to": "to",
        "goals.save": "Save goals",
        "goals.saved": "Saved",
        "footer": "EatLog ¬∑ small step towards mindful eating",
        "detail.back": "‚Üê Back",
        "detail.noEntries": "No entries for this day yet.",
        "confirm.delete": "Delete meal {txt}?",
        "prompt.editNote": "Edit meal note:",
        "prompt.newTime": "New time (format HH:MM, 24-hour):",
        "alert.invalidTime": "Invalid format. Enter, for example: 08:30 or 22:05",
        "alert.invalidTimeRange": "Hours must be 0‚Äì23, minutes 0‚Äì59.",
        "export.noData": "No meals yet to export.",
        "no.description": "(no description)",
        "interval.first": "First recorded meal (no previous entries).",
        "interval.sincePrev": "Interval since previous meal: ",
        "last.meal": "Last meal at ",
        "history.empty": "No data for the selected period yet."
        ,
        "edit.title": "Edit meal",
        "edit.save": "Save",
        "edit.cancel": "Cancel"
      },
      ru: {
        "tab.today": "–°–µ–≥–æ–¥–Ω—è",
        "tab.stats": "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",
        "tab.goals": "–¶–µ–ª–∏",
        "h.newMeal": "–ù–æ–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏",
        "textarea.placeholder": "–æ–≤—Å—è–Ω–∫–∞, 2 –≤–∞—Ä—ë–Ω—ã—Ö —è–π—Ü–∞, –∫–æ—Ñ–µ —Å –ø–µ—á–µ–Ω—å–µ–º",
        "btn.eating": "–Ø –µ–º —Å–µ–π—á–∞—Å",
        "btn.eatingSub": "üçΩ / üç™",
        "stats.today": "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è",
        "today.list": "–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏",
        "stat.meals": "–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏",
        "stat.snacks": "–ò–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤",
        "stat.dayInterval": "–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏",
        "stat.sinceLast": "–° –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–∏—ë–º–∞",
        "list.empty": "–°–µ–≥–æ–¥–Ω—è –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.\n–ù–∞–∂–º–∏ ¬´–Ø –µ–º —Å–µ–π—á–∞—Å¬ª, –∫–æ–≥–¥–∞ –Ω–∞—á–Ω—ë—à—å –µ—Å—Ç—å.\n–ò—Å–ø–æ–ª—å–∑—É–π üçΩ / üç™, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –ø–µ—Ä–µ–∫—É—Å.",
        "period.stats": "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥",
        "daily.breakdown": "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –¥–Ω—è–º",
        "stat.sleep": "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–Ω–∞",
        "table.date": "–î–∞—Ç–∞",
        "table.meals": "–ü—Ä–∏—ë–º—ã –ø–∏—â–∏",
        "table.snacks": "–ò–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤",
        "table.sleep": "–ò–Ω—Ç–µ—Ä–≤–∞–ª\n—Å–Ω–∞",
        "table.dayInterval": "–ò–Ω—Ç–µ—Ä–≤–∞–ª\n–º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏",
        "export.btn": "‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ",
        "export.hint": "–§–∞–π–ª –¥–ª—è Excel/—Ç–∞–±–ª–∏—Ü (.csv)",
        "period.7": "7 –¥–Ω–µ–π",
        "period.14": "14 –¥–Ω–µ–π",
        "period.21": "21 –¥–µ–Ω—å",
        "period.all": "All",
        "goals.title": "–¶–µ–ª–∏ –Ω–∞ –¥–µ–Ω—å",
        "goals.desc": "–î–Ω–∏, –∫–æ–≥–¥–∞ —Ü–µ–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, –±—É–¥—É—Ç –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å—Å—è –∑–µ–ª—ë–Ω—ã–º –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ.",
        "goals.mealsLabel": "–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –≤ –¥–µ–Ω—å",
        "goals.snacksLabel": "–ò–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤ –≤ –¥–µ–Ω—å (–º–∞–∫—Å–∏–º—É–º)",
        "goals.sleepLabel": "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–Ω–∞ (—á–∞—Å—ã)",
        "goals.dayIntervalLabel": "–ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ (—á–∞—Å—ã)",
        "range.from": "–æ—Ç",
        "range.to": "–¥–æ",
        "goals.save": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª–∏",
        "goals.saved": "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ",
        "footer": "EatLog ¬∑ –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∫ –±–æ–ª–µ–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–º—É –ø–∏—Ç–∞–Ω–∏—é",
        "detail.back": "‚Üê –ù–∞–∑–∞–¥",
        "detail.noEntries": "–î–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.",
        "confirm.delete": "–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏ {txt}?",
        "prompt.editNote": "–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏:",
        "prompt.newTime": "–ù–æ–≤–æ–µ –≤—Ä–µ–º—è (—Ñ–æ—Ä–º–∞—Ç –ß–ß:–ú–ú, 24 —á–∞—Å–∞):",
        "alert.invalidTime": "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: 08:30 –∏–ª–∏ 22:05",
        "alert.invalidTimeRange": "–ß–∞—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0‚Äì23, –º–∏–Ω—É—Ç—ã 0‚Äì59.",
        "export.noData": "–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ –¥–ª—è –≤—ã–≥—Ä—É–∑–∫–∏.",
        "no.description": "(–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)",
        "interval.first": "–ü–µ—Ä–≤—ã–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏—ë–º (—Ä–∞–Ω—å—à–µ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç).",
        "interval.sincePrev": "–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å –ø—Ä–æ—à–ª–æ–≥–æ –ø—Ä–∏—ë–º–∞: ",
        "last.meal": "–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º –≤ ",
        "history.empty": "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥."
        ,
        "edit.title": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏",
        "edit.save": "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
        "edit.cancel": "–û—Ç–º–µ–Ω–∞"
      }
    };

    function t(key, params) { // get translation with simple {var} substitution
      const dict = translations[window._eatlogLang || defaultLang] || translations[defaultLang];
      let txt = dict && dict[key] != null ? dict[key] : key;
      if (params) {
        for (const k in params) txt = txt.replace('{' + k + '}', params[k]);
      }
      return txt;
    }

    function applyTranslations(lang) {
      window._eatlogLang = lang;
      document.documentElement.lang = lang;
      localStorage.setItem(LANG_KEY, lang);
      // simple elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (!key) return;
        el.textContent = t(key);
      });
      // placeholders
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (!key) return;
        el.placeholder = t(key);
      });
      // special spans inside add button
      const main = document.getElementById('addMealMain');
      const sub = document.getElementById('addMealSub');
      if (main) main.textContent = t('btn.eating');
      if (sub) sub.textContent = t('btn.eatingSub');
      // Data-driven UI strings are rendered by functions declared later in another <script> tag.
      // When running in the browser, script tags do NOT share hoisting, so guard calls here.
      if (typeof renderMeals === 'function') renderMeals();
      if (typeof renderStats === 'function') renderStats();
      if (typeof renderPeriodSummary === 'function') renderPeriodSummary();
      if (typeof renderHistory === 'function') renderHistory();
      syncLangToggleLabel();
    }

    // language toggle button (single)
    const langToggleBtn = document.getElementById('langToggleBtn');
    function syncLangToggleLabel() {
      if (!langToggleBtn) return;
      const current = window._eatlogLang || defaultLang;
      // Icon shows CURRENT app language
      langToggleBtn.textContent = current.toUpperCase();
      langToggleBtn.title = current === 'ru'
        ? '–Ø–∑—ã–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –†—É—Å—Å–∫–∏–π'
        : 'App language: English';
    }

    if (langToggleBtn) {
      langToggleBtn.addEventListener('click', () => {
        const current = window._eatlogLang || defaultLang;
        const next = current === 'ru' ? 'en' : 'ru';
        applyTranslations(next);
      });
    }

    // apply initial language after all scripts are loaded (so render* functions exist)
    window.addEventListener('DOMContentLoaded', () => {
      applyTranslations(window._eatlogLang || defaultLang);
    });
    // --- end i18n ---
  </script>

  <script>
    const STORAGE_KEY_MEALS = 'meal_tracker_entries_v1';
    const STORAGE_KEY_GOALS = 'meal_tracker_goals_v1';

    function loadMeals() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_MEALS);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error('Failed to parse meals', e);
        return [];
      }
    }

    function saveMeals(meals) {
      localStorage.setItem(STORAGE_KEY_MEALS, JSON.stringify(meals));
    }

    function loadGoals() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_GOALS);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
      } catch (e) {
        console.error('Failed to parse goals', e);
        return {};
      }
    }

    function saveGoals(goals) {
      localStorage.setItem(STORAGE_KEY_GOALS, JSON.stringify(goals));
    }

    let meals = loadMeals();
    let goals = loadGoals();

    const mealNoteEl = document.getElementById('mealNote');
    const addMealBtn = document.getElementById('addMealBtn');
    const mealListEl = document.getElementById('mealList');

    const statMealsTodayEl = document.getElementById('statMealsToday');
    const statSnacksTodayEl = document.getElementById('statSnacksToday');
    const statAvgIntervalEl = document.getElementById('statAvgInterval');
    const statSinceLastEl = document.getElementById('statSinceLast');
    const lastMealInfoEl = document.getElementById('lastMealInfo');

    const historyBodyEl = document.getElementById('historyBody');
    const exportMealsBtn = document.getElementById('exportMealsBtn');

    const tabTodayBtn = document.getElementById('tabToday');
    const tabStatsBtn = document.getElementById('tabStats');
    const tabGoalsBtn = document.getElementById('tabGoals');
    const viewTodayEl = document.getElementById('view-today');
    const viewStatsEl = document.getElementById('view-stats');
    const viewGoalsEl = document.getElementById('view-goals');

    const periodButtons = document.querySelectorAll('.period-btn');
    const statPeriodMealsPerDayEl = document.getElementById('statPeriodMealsPerDay');
    const statPeriodSnacksPerDayEl = document.getElementById('statPeriodSnacksPerDay');
    const statPeriodSleepIntervalEl = document.getElementById('statPeriodSleepInterval');
    const statPeriodAvgIntervalEl = document.getElementById('statPeriodAvgInterval');

    const goalMealsMinEl = document.getElementById('goalMealsMin');
    const goalMealsMaxEl = document.getElementById('goalMealsMax');
    const goalSnacksMaxEl = document.getElementById('goalSnacksMax');
    const goalSleepMinEl = document.getElementById('goalSleepMin');
    const goalSleepMaxEl = document.getElementById('goalSleepMax');
    const goalDayIntMinEl = document.getElementById('goalDayIntMin');
    const goalDayIntMaxEl = document.getElementById('goalDayIntMax');
    const saveGoalsBtn = document.getElementById('saveGoalsBtn');
    const goalsStatusEl = document.getElementById('goalsStatus');

    const detailScreen = document.getElementById('detailScreen');
    const btnDetailBack = document.getElementById('btnDetailBack');
    const detailTitle = document.getElementById('detailTitle');
    const detailContent = document.getElementById('detailContent');
    let currentDetailDayKey = null;

    let currentPeriod = 'all';
    function isSameDay(ts, refDate) {
      const d1 = new Date(ts);
      const d2 = new Date(refDate);
      return d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();
    }

    function getDayKey(dateOrTs) {
      const d = dateOrTs instanceof Date ? dateOrTs : new Date(dateOrTs);
      return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
    }

    function formatTimeHM(ts) {
      const lang = window._eatlogLang === 'ru' ? 'ru-RU' : undefined;
      const d = new Date(ts);
      return d.toLocaleTimeString(lang, { hour: '2-digit', minute: '2-digit' });
    }

    function formatDateDMY(ts) {
      const lang = window._eatlogLang === 'ru' ? 'ru-RU' : undefined;
      const d = new Date(ts);
      return d.toLocaleDateString(lang, { day: '2-digit', month: '2-digit' });
    }

    function formatInterval(ms) {
      if (ms == null || isNaN(ms)) return '‚Äì';

      const totalMin = Math.floor(ms / 60000);
      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      const lang = window._eatlogLang || defaultLang;

      if (lang === 'ru') {
        if (h > 0 && m > 0) return `${h} —á ${m} –º`;
        if (h > 0) return `${h} —á`;
        return `${m} –º`;
      } else {
        // English / fallback: use short "h" / "m"
        if (h > 0 && m > 0) return `${h}h ${m}m`;
        if (h > 0) return `${h}h`;
        return `${m}m`;
      }
    }

    function formatNumberPerDay(value) {
      if (!isFinite(value)) return '0';
      const fixed = value.toFixed(1);
      if (fixed.endsWith('.0')) return fixed.slice(0, -2);
      return fixed;
    }

    function getAllMealsSorted() {
      return [...meals].sort((a, b) => a.ts - b.ts);
    }

    function getTodayMeals() {
      const now = new Date();
      return meals
        .filter(m => isSameDay(m.ts, now))
        .sort((a, b) => a.ts - b.ts);
    }

    function deleteMeal(id) {
      const entry = meals.find(m => m.id === id);
      const preview = entry ? ('"' + (entry.note || '').slice(0, 30) + (entry.note && entry.note.length > 30 ? '‚Ä¶' : '') + '"') : '';
      if (!confirm(t('confirm.delete', { txt: preview }))) return;

      meals = meals.filter(m => m.id !== id);
      saveMeals(meals);
      renderMeals();
      renderStats();
      renderPeriodSummary();
      renderHistory();
      refreshDetailIfOpen();
    }

    function editMealNote(id) {
      const entry = meals.find(m => m.id === id);
      if (!entry) return;
      const currentNote = entry.note || '';
      const updated = prompt(t('prompt.editNote'), currentNote);
      if (updated === null) return;
      entry.note = updated.trim();
      saveMeals(meals);
      renderMeals();
      renderHistory();
      renderPeriodSummary();
      refreshDetailIfOpen();
    }

    function editMealTime(id) {
      const entry = meals.find(m => m.id === id);
      if (!entry) return;
      const d = new Date(entry.ts);
      const currentHH = String(d.getHours()).padStart(2, '0');
      const currentMM = String(d.getMinutes()).padStart(2, '0');
      const current = currentHH + ':' + currentMM;

      const input = prompt(t('prompt.newTime'), current);
      if (input === null) return;

      const trimmed = input.trim();
      const match = /^([0-9]{1,2}):([0-9]{2})$/.exec(trimmed);
      if (!match) {
        alert(t('alert.invalidTime'));
        return;
      }

      let hh = parseInt(match[1], 10);
      let mm = parseInt(match[2], 10);

      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) {
        alert(t('alert.invalidTimeRange'));
        return;
      }

      const newDate = new Date(entry.ts);
      newDate.setHours(hh, mm, 0, 0);
      entry.ts = newDate.getTime();

      saveMeals(meals);
      renderMeals();
      renderStats();
      renderHistory();
      renderPeriodSummary();
      refreshDetailIfOpen();
    }

    function toggleSnack(id) {
      const entry = meals.find(m => m.id === id);
      if (!entry) return;
      entry.isSnack = !entry.isSnack;
      saveMeals(meals);
      renderMeals();
      renderStats();
      renderHistory();
      renderPeriodSummary();
      refreshDetailIfOpen();
    }

    function renderMeals() {
      const todayMeals = getTodayMeals();
      mealListEl.innerHTML = '';

      if (todayMeals.length === 0) {
        mealListEl.innerHTML = '<div class="subtle">' + t('list.empty') + '</div>';
        lastMealInfoEl.textContent = '';
        return;
      }

      const allSorted = getAllMealsSorted();
      const firstToday = todayMeals[0];
      const firstIndex = allSorted.findIndex(m => m.id === firstToday.id);

      let globalPrevTs = null;
      if (firstIndex > 0) {
        globalPrevTs = allSorted[firstIndex - 1].ts;
      }

      let prevTs = globalPrevTs;

      for (const meal of todayMeals) {
        const row = document.createElement('div');
        row.className = 'meal-row';

        const top = document.createElement('div');
        top.className = 'row-top';

        const leftWrap = document.createElement('div');
        const timeEl = document.createElement('span');
        timeEl.className = 'meal-time';
        timeEl.textContent = formatTimeHM(meal.ts);

        leftWrap.appendChild(timeEl);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const snackBtn = document.createElement('button');
        snackBtn.className = 'btn-ghost';
        snackBtn.textContent = meal.isSnack ? 'üç™' : 'üçΩ';
        snackBtn.title = meal.isSnack
          ? '–û—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø–µ—Ä–µ–∫—É—Å (–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–±—ã—á–Ω—ã–º –ø—Ä–∏—ë–º–æ–º)'
          : '–û–±—ã—á–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ (–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø–µ—Ä–µ–∫—É—Å)';
        snackBtn.onclick = () => toggleSnack(meal.id);

        const editTimeBtn = document.createElement('button');
        editTimeBtn.className = 'btn-ghost';
        editTimeBtn.textContent = '‚è∞';
        editTimeBtn.title = '–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è';
        editTimeBtn.onclick = () => editMealTime(meal.id);

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-ghost';
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ';
        editBtn.onclick = () => editMealNote(meal.id);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-danger';
        delBtn.textContent = 'üóë';
        delBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—ë–º';
        delBtn.onclick = () => deleteMeal(meal.id);

        actions.appendChild(snackBtn);
        actions.appendChild(editTimeBtn);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        top.appendChild(leftWrap);
        top.appendChild(actions);

        const noteEl = document.createElement('div');
        noteEl.className = 'meal-note';
        noteEl.textContent = meal.note || t('no.description');

        const intervalEl = document.createElement('div');
        intervalEl.className = 'meal-interval';

        if (prevTs == null) {
          intervalEl.textContent = t('interval.first');
        } else {
          const diff = meal.ts - prevTs;
          intervalEl.textContent = t('interval.sincePrev') + formatInterval(diff);
        }

        prevTs = meal.ts;

        row.appendChild(top);
        row.appendChild(noteEl);
        row.appendChild(intervalEl);

        mealListEl.appendChild(row);
      }

      if (todayMeals.length > 0) {
        lastMealInfoEl.textContent = t('last.meal') + formatTimeHM(todayMeals[todayMeals.length - 1].ts);
      } else {
        lastMealInfoEl.textContent = '';
      }
    }

    function getTodayIntervalsWithinDay() {
      const todayMeals = getTodayMeals();
      if (todayMeals.length <= 1) return [];

      const intervals = [];
      for (let i = 1; i < todayMeals.length; i++) {
        intervals.push(todayMeals[i].ts - todayMeals[i - 1].ts);
      }
      return intervals;
    }

    function renderStats() {
      const todayMeals = getTodayMeals();
      const count = todayMeals.length;
      const snacksCount = todayMeals.filter(m => m.isSnack).length;

      statMealsTodayEl.textContent = String(count);
      statSnacksTodayEl.textContent = String(snacksCount);

      const intervals = getTodayIntervalsWithinDay();
      if (intervals.length === 0) {
        statAvgIntervalEl.textContent = '‚Äì';
      } else {
        const sum = intervals.reduce((a, b) => a + b, 0);
        const avg = sum / intervals.length;
        statAvgIntervalEl.textContent = formatInterval(avg);
      }

      // üîΩ –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è "–° –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ"
      const allSorted = getAllMealsSorted();

      if (allSorted.length === 0) {
        // –í–æ–æ–±—â–µ –µ—â—ë –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞ –Ω–µ –±—ã–ª–æ
        statSinceLastEl.textContent = '‚Äì';
        lastMealInfoEl.textContent = '';
        return;
      }

      // –ë–µ—Ä—ë–º —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º (–≤—á–µ—Ä–∞/—Å–µ–≥–æ–¥–Ω—è ‚Äî –Ω–µ –≤–∞–∂–Ω–æ)
      const last = allSorted[allSorted.length - 1];
      const diff = Date.now() - last.ts;
      statSinceLastEl.textContent = formatInterval(diff);
      lastMealInfoEl.textContent = t('last.meal') + formatTimeHM(last.ts);
    }

    function getSleepIntervalForDay(dayMeals, allMeals) {
      const first = dayMeals[0];
      let prev = null;
      for (const m of allMeals) {
        if (m.ts < first.ts) {
          if (!prev || m.ts > prev.ts) {
            prev = m;
          }
        }
      }
      if (!prev) return null;
      return first.ts - prev.ts;
    }

    function computeDailyStats() {
      if (meals.length === 0) return [];

      const byDayKey = {};
      for (const m of meals) {
        const dKey = getDayKey(m.ts);
        if (!byDayKey[dKey]) byDayKey[dKey] = [];
        byDayKey[dKey].push(m);
      }

      const allSorted = getAllMealsSorted();
      const result = [];

      for (const key in byDayKey) {
        const dayMeals = byDayKey[key].sort((a, b) => a.ts - b.ts);
        const count = dayMeals.length;
        const snacksCount = dayMeals.filter(m => m.isSnack).length;

        let intervals = [];
        if (count > 1) {
          for (let i = 1; i < dayMeals.length; i++) {
            intervals.push(dayMeals[i].ts - dayMeals[i - 1].ts);
          }
        }

        let avg = null;
        if (intervals.length > 0) {
          const sum = intervals.reduce((a, b) => a + b, 0);
          avg = sum / intervals.length;
        }

        const sleepInterval = getSleepIntervalForDay(dayMeals, allSorted);

        result.push({
          key,
          ts: dayMeals[0].ts,
          count,
          snacksCount,
          sleepInterval,
          avgInterval: avg
        });
      }

      result.sort((a, b) => b.ts - a.ts);
      return result;
    }

    function getFilteredDailyStats() {
      const all = computeDailyStats();

      // –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥
      if (currentPeriod === 'all') return all;

      const days = parseInt(currentPeriod, 10);
      if (!isFinite(days) || days <= 0) return all;

      const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
      return all.filter(d => d.ts >= cutoff);
    }

    // –í–´–ì–†–£–ó–ö–ê –í–°–ï–• –ü–†–ò–Å–ú–û–í –ü–ò–©–ò –í CSV
    function exportMealsCsv() {
      const all = getAllMealsSorted();
      if (!all.length) {
        alert(t('export.noData'));
        return;
      }

      function escapeCsvField(value) {
        if (value == null) return '';
        const str = String(value);
        if (/[;"\n]/.test(str)) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      }

      const headers = ['day_key', 'date', 'time', 'type', 'note'];
      const lines = [headers.join(';')];

      for (const m of all) {
        const d = new Date(m.ts);
        const dayKey = getDayKey(m.ts);
        const dateStr = d.toLocaleDateString('ru-RU', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit'
        });
        const timeStr = d.toLocaleTimeString('ru-RU', {
          hour: '2-digit',
          minute: '2-digit'
        });
        const typeStr = m.isSnack ? '–ø–µ—Ä–µ–∫—É—Å' : '–æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–∏—ë–º';
        const noteStr = m.note || '';

        lines.push([
          escapeCsvField(dayKey),
          escapeCsvField(dateStr),
          escapeCsvField(timeStr),
          escapeCsvField(typeStr),
          escapeCsvField(noteStr)
        ].join(';'));
      }

      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'eatlog_meals_' + new Date().toISOString().slice(0, 10) + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function hasAnyGoal() {
      return (
        goals.minMealsPerDay != null ||
        goals.maxMealsPerDay != null ||
        goals.maxSnacksPerDay != null ||
        goals.minSleepHours != null ||
        goals.maxSleepHours != null ||
        goals.minDayIntervalMinutes != null ||
        goals.maxDayIntervalMinutes != null
      );
    }

    function isDayInTarget(day) {
      if (!hasAnyGoal()) return false;

      if (goals.minMealsPerDay != null && day.count < goals.minMealsPerDay) return false;
      if (goals.maxMealsPerDay != null && day.count > goals.maxMealsPerDay) return false;

      if (goals.maxSnacksPerDay != null && (day.snacksCount || 0) > goals.maxSnacksPerDay) return false;

      if (day.sleepInterval != null) {
        const sleepHours = day.sleepInterval / (60 * 60 * 1000);
        if (goals.minSleepHours != null && sleepHours < goals.minSleepHours) return false;
        if (goals.maxSleepHours != null && sleepHours > goals.maxSleepHours) return false;
      } else {
        if (goals.minSleepHours != null || goals.maxSleepHours != null) return false;
      }

      if (day.avgInterval != null) {
        const dayIntervalMinutes = day.avgInterval / 60000;
        if (goals.minDayIntervalMinutes != null && dayIntervalMinutes < goals.minDayIntervalMinutes) return false;
        if (goals.maxDayIntervalMinutes != null && dayIntervalMinutes > goals.maxDayIntervalMinutes) return false;
      } else {
        if (goals.minDayIntervalMinutes != null || goals.maxDayIntervalMinutes != null) return false;
      }

      return true;
    }

    function renderPeriodSummary() {
      const stats = getFilteredDailyStats();

      const daysCount = stats.length;
      let totalMeals = 0;
      let totalSnacks = 0;
      const sleepIntervals = [];
      const dayAvgIntervals = [];

      for (const d of stats) {
        totalMeals += d.count;
        totalSnacks += d.snacksCount || 0;
        if (d.sleepInterval != null) sleepIntervals.push(d.sleepInterval);
        if (d.avgInterval != null) dayAvgIntervals.push(d.avgInterval);
      }

      if (daysCount === 0) {
        statPeriodMealsPerDayEl.textContent = '0';
        statPeriodSnacksPerDayEl.textContent = '0';
      } else {
        const avgMealsPerDay = totalMeals / daysCount;
        const avgSnacksPerDay = totalSnacks / daysCount;
        statPeriodMealsPerDayEl.textContent = formatNumberPerDay(avgMealsPerDay);
        statPeriodSnacksPerDayEl.textContent = formatNumberPerDay(avgSnacksPerDay);
      }

      if (sleepIntervals.length === 0) {
        statPeriodSleepIntervalEl.textContent = '‚Äì';
      } else {
        const sumSleep = sleepIntervals.reduce((a, b) => a + b, 0);
        const avgSleep = sumSleep / sleepIntervals.length;
        statPeriodSleepIntervalEl.textContent = formatInterval(avgSleep);
      }

      if (dayAvgIntervals.length === 0) {
        statPeriodAvgIntervalEl.textContent = '‚Äì';
      } else {
        const sum = dayAvgIntervals.reduce((a, b) => a + b, 0);
        const avg = sum / dayAvgIntervals.length;
        statPeriodAvgIntervalEl.textContent = formatInterval(avg);
      }
    }

    function renderHistory() {
      const stats = getFilteredDailyStats();
      historyBodyEl.innerHTML = '';

      if (stats.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.className = 'subtle';
        td.textContent = t('history.empty');
        tr.appendChild(td);
        historyBodyEl.appendChild(tr);
        return;
      }

      for (const day of stats) {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';

        if (isDayInTarget(day)) {
          tr.className = 'day-ok';
        }

        tr.onclick = () => openDayDetail(day);

        const tdDate = document.createElement('td');
        tdDate.textContent = formatDateDMY(day.ts);

        const tdCount = document.createElement('td');
        tdCount.textContent = day.count;

        const tdSnacks = document.createElement('td');
        tdSnacks.textContent = day.snacksCount || 0;

        const tdSleep = document.createElement('td');
        tdSleep.textContent =
          day.sleepInterval != null ? formatInterval(day.sleepInterval) : '‚Äì';

        const tdAvg = document.createElement('td');
        tdAvg.textContent =
          day.avgInterval != null ? formatInterval(day.avgInterval) : '‚Äì';

        tr.appendChild(tdDate);
        tr.appendChild(tdCount);
        tr.appendChild(tdSnacks);
        tr.appendChild(tdSleep);
        tr.appendChild(tdAvg);

        historyBodyEl.appendChild(tr);
      }
    }

    function openDayDetail(day) {
      currentDetailDayKey = day.key;
      detailTitle.textContent = formatDateDMY(day.ts);

      const allSorted = getAllMealsSorted();
      const dayMeals = allSorted.filter(m => getDayKey(m.ts) === day.key);

      if (dayMeals.length === 0) {
        detailContent.innerHTML = '<p class="subtle">' + t('detail.noEntries') + '</p>';
        detailScreen.style.display = 'block';
        return;
      }

      let html = '';
      const firstDay = dayMeals[0];
      const firstIndex = allSorted.findIndex(m => m.id === firstDay.id);
      let prevTs = null;
      if (firstIndex > 0) {
        prevTs = allSorted[firstIndex - 1].ts;
      }

      for (const meal of dayMeals) {
        const intervalText = prevTs == null
          ? t('interval.first')
          : t('interval.sincePrev') + formatInterval(meal.ts - prevTs);

        prevTs = meal.ts;

        html += `
            <div class="meal-row">
              <div class="row-top">
                <div>
                  <span class="meal-time">${formatTimeHM(meal.ts)}</span>
                </div>
                <div class="actions">
                  <button class="btn-ghost"
                    title="${meal.isSnack
            ? '–û—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø–µ—Ä–µ–∫—É—Å (–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–±—ã—á–Ω—ã–º –ø—Ä–∏—ë–º–æ–º)'
            : '–û–±—ã—á–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ (–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø–µ—Ä–µ–∫—É—Å)'}"
                    onclick="toggleSnack('${meal.id}')">
                    ${meal.isSnack ? 'üç™' : 'üçΩ'}
                  </button>
                  <button class="btn-ghost" title="–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è"
                    onclick="editMealTime('${meal.id}')">‚è∞</button>
                  <button class="btn-ghost" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ"
                    onclick="editMealNote('${meal.id}')">‚úèÔ∏è</button>
                  <button class="btn-danger" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—ë–º"
                    onclick="deleteMeal('${meal.id}')">üóë</button>
                </div>
              </div>
              <div class="meal-note">${meal.note || t('no.description')}</div>
              <div class="meal-interval">${intervalText}</div>
            </div>
          `;
      }

      detailContent.innerHTML = html;
      detailScreen.style.display = 'block';
    }

    function refreshDetailIfOpen() {
      if (!currentDetailDayKey || detailScreen.style.display !== 'block') return;
      const allStats = computeDailyStats();
      const day = allStats.find(d => d.key === currentDetailDayKey);
      if (!day) {
        detailScreen.style.display = 'none';
        currentDetailDayKey = null;
        return;
      }
      openDayDetail(day);
    }

    btnDetailBack.addEventListener('click', () => {
      detailScreen.style.display = 'none';
      currentDetailDayKey = null;
    });

    function tickSinceLast() {
      renderStats();
    }

    setInterval(tickSinceLast, 60000);

    addMealBtn.addEventListener('click', () => {
      const note = (mealNoteEl.value || '').trim();
      const now = Date.now();

      const newMeal = {
        id: 'm_' + now + '_' + Math.random().toString(36).slice(2, 8),
        ts: now,
        note,
        isSnack: false
      };

      meals.push(newMeal);
      saveMeals(meals);

      mealNoteEl.value = '';

      renderMeals();
      renderStats();
      renderPeriodSummary();
      renderHistory();
      refreshDetailIfOpen();
    });

    function switchView(view) {
      if (view === 'today') {
        viewTodayEl.style.display = '';
        viewStatsEl.style.display = 'none';
        viewGoalsEl.style.display = 'none';
        tabTodayBtn.classList.add('active');
        tabStatsBtn.classList.remove('active');
        tabGoalsBtn.classList.remove('active');
      } else if (view === 'stats') {
        viewTodayEl.style.display = 'none';
        viewStatsEl.style.display = '';
        viewGoalsEl.style.display = 'none';
        tabTodayBtn.classList.remove('active');
        tabStatsBtn.classList.add('active');
        tabGoalsBtn.classList.remove('active');
      } else {
        viewTodayEl.style.display = 'none';
        viewStatsEl.style.display = 'none';
        viewGoalsEl.style.display = '';
        tabTodayBtn.classList.remove('active');
        tabStatsBtn.classList.remove('active');
        tabGoalsBtn.classList.add('active');
      }
    }

    tabTodayBtn.addEventListener('click', () => switchView('today'));
    tabStatsBtn.addEventListener('click', () => switchView('stats'));
    tabGoalsBtn.addEventListener('click', () => switchView('goals'));

    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        periodButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPeriod = btn.dataset.period;
        renderPeriodSummary();
        renderHistory();
        refreshDetailIfOpen();
      });
    });

    function loadGoalsIntoUI() {
      if (goals.minMealsPerDay != null) goalMealsMinEl.value = goals.minMealsPerDay;
      if (goals.maxMealsPerDay != null) goalMealsMaxEl.value = goals.maxMealsPerDay;
      if (goals.maxSnacksPerDay != null) goalSnacksMaxEl.value = goals.maxSnacksPerDay;
      if (goals.minSleepHours != null) goalSleepMinEl.value = goals.minSleepHours;
      if (goals.maxSleepHours != null) goalSleepMaxEl.value = goals.maxSleepHours;
      if (goals.minDayIntervalMinutes != null) goalDayIntMinEl.value = goals.minDayIntervalMinutes / 60;
      if (goals.maxDayIntervalMinutes != null) goalDayIntMaxEl.value = goals.maxDayIntervalMinutes / 60;
    }


    function animateSaveGoalsButton(btn) {
      if (!btn) return;
      const label = btn.querySelector('.savebtn__label');

      // If animation is already running, restart cleanly
      if (btn._saveAnimTimers) {
        btn._saveAnimTimers.forEach(id => clearTimeout(id));
      }
      btn._saveAnimTimers = [];

      // Ensure default label is correct for current language
      const defaultKey = label?.dataset.defaultKey || 'goals.save';
      const defaultText = t(defaultKey);

      // Stage 1: saving (spinner)
      btn.classList.remove('is-saved');
      btn.classList.add('is-saving');
      btn.disabled = true;
      if (label) label.textContent = defaultText;

      // Stage 2: saved (checkmark + short label)
      const t1 = setTimeout(() => {
        btn.classList.remove('is-saving');
        btn.classList.add('is-saved');
        if (label) label.textContent = t('goals.saved');
      }, 350);

      // Stage 3: back to normal
      const t2 = setTimeout(() => {
        btn.classList.remove('is-saved');
        btn.disabled = false;
        if (label) label.textContent = defaultText;
      }, 1450);

      btn._saveAnimTimers.push(t1, t2);
    }

    saveGoalsBtn.addEventListener('click', () => {
      function numOrNull(el) {
        const v = el.value.trim();
        if (!v) return null;
        const n = Number(v.replace(',', '.'));
        return isNaN(n) ? null : n;
      }

      const minMeals = numOrNull(goalMealsMinEl);
      const maxMeals = numOrNull(goalMealsMaxEl);
      const maxSnacks = numOrNull(goalSnacksMaxEl);
      const minSleepHours = numOrNull(goalSleepMinEl);
      const maxSleepHours = numOrNull(goalSleepMaxEl);
      const minDayIntHours = numOrNull(goalDayIntMinEl);
      const maxDayIntHours = numOrNull(goalDayIntMaxEl);

      goals = {
        minMealsPerDay: minMeals != null ? minMeals : null,
        maxMealsPerDay: maxMeals != null ? maxMeals : null,
        maxSnacksPerDay: maxSnacks != null ? maxSnacks : null,
        minSleepHours: minSleepHours != null ? minSleepHours : null,
        maxSleepHours: maxSleepHours != null ? maxSleepHours : null,
        minDayIntervalMinutes: minDayIntHours != null ? minDayIntHours * 60 : null,
        maxDayIntervalMinutes: maxDayIntHours != null ? maxDayIntHours * 60 : null
      };

      saveGoals(goals);

      animateSaveGoalsButton(saveGoalsBtn);

      renderPeriodSummary();
      renderHistory();
    });


    function animateExportButton(btn) {
      if (!btn) return;
      const label = btn.querySelector('.exportbtn__label');

      // Restart cleanly if user taps fast
      if (btn._exportAnimTimers) {
        btn._exportAnimTimers.forEach(id => clearTimeout(id));
      }
      btn._exportAnimTimers = [];

      const defaultKey = label?.dataset.defaultKey || 'export.btn';
      const defaultText = t(defaultKey);

      btn.classList.remove('is-saved');
      btn.classList.add('is-saving');
      btn.disabled = true;
      if (label) label.textContent = t('export.downloading');

      const t1 = setTimeout(() => {
        btn.classList.remove('is-saving');
        btn.classList.add('is-saved');
        if (label) label.textContent = t('export.done');
      }, 450);

      const t2 = setTimeout(() => {
        btn.classList.remove('is-saved');
        btn.disabled = false;
        if (label) label.textContent = defaultText;
      }, 1550);

      btn._exportAnimTimers.push(t1, t2);
    }


    // –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤—ã–≥—Ä—É–∑–∫—É CSV
    if (exportMealsBtn) {
      exportMealsBtn.addEventListener('click', exportMealsCsv);
    }

    loadGoalsIntoUI();

    // Fast first paint: render today + top stats first
    renderMeals();
    renderStats();

    // Defer heavier computations (period summary + history) to idle time
    const _runIdle = (fn) => {
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => fn(), { timeout: 900 });
      } else {
        setTimeout(fn, 60);
      }
    };

    _runIdle(() => {
      renderPeriodSummary();
      renderHistory();
      refreshDetailIfOpen();
    });

    // Hide splash after the first frame where UI is ready
    const splash = document.getElementById('splash');
    if (splash) {
      requestAnimationFrame(() => {
        // second frame to ensure styles are applied
        requestAnimationFrame(() => {
          splash.classList.add('is-hiding');
          setTimeout(() => splash.remove(), 260);
        });
      });
    }
  </script>
</body>

</html>