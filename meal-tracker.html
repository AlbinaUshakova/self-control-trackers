<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <title>EatLog ‚Äî —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="apple-touch-icon" href="eatlog-icon.png">
  <style>
    :root {
      color-scheme: dark;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      min-height: 100vh;
      background:
        radial-gradient(circle at top, #020617 0, #020617 55%, #000 100%);
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px 12px;
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      border-radius: 28px;
      padding: 14px 14px 20px;
      background: rgba(15, 23, 42, 0.96);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      display: flex;
      flex-direction: column;
      max-height: 100%;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: 0.02em;
    }

    .subtle {
      font-size: 12px;
      color: #9ca3af;
      margin: 4px 2px 10px;
    }

    /* –í–∫–ª–∞–¥–∫–∏ */
    .view-tabs-wrapper {
      margin: 4px 0 10px;
    }

    .view-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
    }

    .tab-btn {
      flex: 1;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.15s ease, color 0.15s ease, transform 0.08s ease;
    }

    .tab-btn.active {
      background: #e5e7eb;
      color: #020617;
      transform: translateY(-1px);
    }

    /* –ö–æ–Ω—Ç–µ–Ω—Ç-–æ–±–ª–∞—Å—Ç—å */
    .app-content {
      flex: 1;
      overflow-y: auto;
      padding-right: 2px;
      padding-bottom: 8px;
      margin-top: 2px;
    }

    h2 {
      font-size: 17px;
      margin-top: 0;
      margin-bottom: 6px;
      letter-spacing: 0.01em;
    }

    .card {
      background: #020617;
      border-radius: 16px;
      padding: 12px 12px 10px;
      margin-bottom: 10px;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.45);
      border: none;
    }

    .card-compact {
      padding-top: 10px;
      padding-bottom: 10px;
    }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 9px 11px;
      font-size: 14px;
      margin-bottom: 10px;
      resize: vertical;
      min-height: 52px;
      outline: none;
      transition: border-color 0.12s ease, background 0.12s ease;
    }

    textarea:focus {
      border-color: #22c55e;
      background: #020617;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 9px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 6px;
      margin-top: 4px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: background 0.15s ease, transform 0.08s ease;
      white-space: nowrap;
    }

    button:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      width: 100%;
      justify-content: center;
      box-shadow: none;
    }

    .btn-primary:hover {
      background: #16a34a;
    }

    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .btn-outline:hover {
      background: rgba(15, 23, 42, 0.9);
    }

    .btn-danger {
      background: transparent;
      color: #fca5a5;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: rgba(127, 29, 29, 0.3);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
    }

    .btn-ghost:hover {
      background: rgba(31, 41, 55, 1);
    }

    .list {
      max-height: 360px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .meal-row {
      border-bottom: 1px solid #111827;
      padding: 7px 0;
      font-size: 14px;
    }

    .meal-row:last-child {
      border-bottom: none;
    }

    .row-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .actions {
      display: flex;
      gap: 4px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .meal-time {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      font-size: 14px;
    }

    .meal-note {
      color: #e5e7eb;
      word-break: break-word;
      font-size: 13px;
    }

    .meal-interval {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .stat-box {
      background: #020617;
      border-radius: 12px;
      padding: 8px 9px;
      font-size: 13px;
      border: none;
      box-shadow: none;
      min-height: 52px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .stat-label {
      color: #9ca3af;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 1px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    .history-wrapper {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 12px;
      margin-top: 4px;
      background: #020617;
    }

    /* –¢–ê–ë–õ–ò–¶–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ */
      font-size: 11px;
      /* —á—É—Ç—å –º–µ–Ω—å—à–µ –æ–±—â–∏–π —à—Ä–∏—Ñ—Ç */
      background: transparent;
    }

    th,
    td {
      padding: 10px 6px;
      /* –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ */
      text-align: center;
      /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
      border-bottom: 1px solid #111827;
      vertical-align: middle;
      /* –∫—Ä–∞—Å–∏–≤–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    }

    /* –£–∂–µ –¥–∞—Ç–∞ –∏ —Å—á—ë—Ç—á–∏–∫–∏, –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ –ø–æ–¥ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã */
    th:nth-child(1),
    td:nth-child(1) {
      width: 16%;
    }

    th:nth-child(2),
    td:nth-child(2) {
      width: 16%;
    }

    th:nth-child(3),
    td:nth-child(3) {
      width: 16%;
    }

    th:nth-child(4),
    td:nth-child(4) {
      width: 26%;
    }

    th:nth-child(5),
    td:nth-child(5) {
      width: 26%;
    }

    th {
      font-size: 9px;
      /* –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–º–µ–Ω—å—à–µ */
      color: #9ca3af;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
      text-align: center;
      white-space: normal;
      /* —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å */
      line-height: 1.2;
    }

    td {
      text-align: left;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr {
      transition: background 0.12s ease;
    }

    tbody tr:hover {
      background: #020617;
    }

    /* –ü–µ—Ä–∏–æ–¥ */
    .period-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 6px 0 6px;
    }

    .period-btn {
      padding: 5px 10px;
      font-size: 12px;
      border-radius: 999px;
    }

    .period-btn.active {
      background: #e5e7eb;
      color: #020617;
      border-color: transparent;
    }

    /* –¶–µ–ª–∏ */
    .goal-row {
      margin-bottom: 9px;
      font-size: 13px;
    }

    .goal-row span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    input[type="number"] {
      width: 72px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 4px 6px;
      font-size: 13px;
      outline: none;
      transition: border-color 0.12s ease;
    }

    input[type="number"]:focus {
      border-color: #22c55e;
    }

    .day-ok td {
      background: rgba(22, 163, 74, 0.22);
    }

    .app-footer {
      margin-top: 4px;
      font-size: 10px;
      text-align: center;
      color: #6b7280;
    }

    /* FULLSCREEN DETAIL */
    #detailScreen {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: #020617;
      z-index: 200;
      padding: 16px;
      overflow-y: auto;
    }

    #btnDetailBack {
      background: none;
      border: none;
      color: #e5e7eb;
      font-size: 18px;
      margin-bottom: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #detailTitle {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 18px;
    }

    @media (max-width: 480px) {
      .app-shell {
        border-radius: 24px;
        padding-inline: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="app-header">
      <div>
        <h1>EatLog</h1>
      </div>
    </header>

    <div class="view-tabs-wrapper">
      <div class="view-tabs">
        <button id="tabToday" class="tab-btn active">–°–µ–≥–æ–¥–Ω—è</button>
        <button id="tabStats" class="tab-btn">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        <button id="tabGoals" class="tab-btn">–¶–µ–ª–∏</button>
      </div>
    </div>

    <div class="app-content">
      <!-- –°–ï–ì–û–î–ù–Ø -->
      <div id="view-today">
        <div class="card">
          <h2>–ù–æ–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏</h2>
          <label for="mealNote">–ß—Ç–æ —Ç—ã –µ—à—å? (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
          <textarea id="mealNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–û–≤—Å—è–Ω–∫–∞ —Å —Å–µ–º–µ—á–∫–∞–º–∏¬ª, ¬´–ß–∏–ø—Å—ã¬ª, ¬´–ß–∞–π —Å –ø–µ—á–µ–Ω—å–µ–º¬ª"></textarea>
          <button id="addMealBtn" class="btn-primary">
            <span>–Ø –µ–º —Å–µ–π—á–∞—Å</span>
            <span>üçΩ üç™</span>
          </button>
          <p class="subtle" id="lastMealInfo"></p>
        </div>

        <div class="card card-compact">
          <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label">–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</div>
              <div class="stat-value" id="statMealsToday">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">–ò–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤ üç™</div>
              <div class="stat-value" id="statSnacksToday">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">–î–Ω–µ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</div>
              <div class="stat-value" id="statAvgInterval">‚Äì</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">–°–µ–π—á–∞—Å –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ</div>
              <div class="stat-value" id="statSinceLast">‚Äì</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏</h2>
          <div class="list" id="mealList"></div>
        </div>
      </div>

      <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
      <div id="view-stats" style="display: none;">
        <div class="card">
          <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</h2>
          <div class="period-controls">
            <button class="btn-outline period-btn" data-period="3">3 –¥–Ω—è</button>
            <button class="btn-outline period-btn active" data-period="7">7 –¥–Ω–µ–π</button>
            <button class="btn-outline period-btn" data-period="14">14 –¥–Ω–µ–π</button>
            <button class="btn-outline period-btn" data-period="21">21 –¥–µ–Ω—å</button>
          </div>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label">–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</div>
              <div class="stat-value" id="statPeriodMealsPerDay">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">–ò–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤ üç™</div>
              <div class="stat-value" id="statPeriodSnacksPerDay">0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–Ω–∞</div>
              <div class="stat-value" id="statPeriodSleepInterval">‚Äì</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">–î–Ω–µ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</div>
              <div class="stat-value" id="statPeriodAvgInterval">‚Äì</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –¥–Ω—è–º</h2>
          <div class="history-wrapper">
            <table>
              <thead>
                <tr>
                  <th>–î–∞—Ç–∞</th>
                  <th>–ü—Ä–∏—ë–º—ã –ø–∏—â–∏</th>
                  <th>–ü–µ—Ä–µ–∫—É—Å—ã üç™</th>
                  <th>–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–Ω–∞</th>
                  <th>–î–Ω–µ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</th>
                </tr>
              </thead>
              <tbody id="historyBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- –¶–ï–õ–ò -->
      <div id="view-goals" style="display: none;">
        <div class="card">
          <h2>–¶–µ–ª–∏ –Ω–∞ –¥–µ–Ω—å</h2>
          <p class="subtle">
            –î–Ω–∏, –∫–æ–≥–¥–∞ —Ç—ã –¥–æ—Å—Ç–∏–≥–ª–∞ —ç—Ç–∏—Ö —Ü–µ–ª–µ–π, –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –±—É–¥—É—Ç –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å—Å—è –∑–µ–ª—ë–Ω—ã–º.
          </p>

          <div class="goal-row">
            <div class="subtle">–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏ –≤ –¥–µ–Ω—å</div>
            <span>
              –æ—Ç <input type="number" id="goalMealsMin" min="0" step="1" />
              –¥–æ <input type="number" id="goalMealsMax" min="0" step="1" />
            </span>
          </div>

          <div class="goal-row">
            <div class="subtle">–ò–∑ –Ω–∏—Ö –ø–µ—Ä–µ–∫—É—Å–æ–≤ üç™ –≤ –¥–µ–Ω—å (–º–∞–∫—Å–∏–º—É–º)</div>
            <span>
              –¥–æ <input type="number" id="goalSnacksMax" min="0" step="1" />
            </span>
          </div>

          <div class="goal-row">
            <div class="subtle">–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–Ω–∞ (—á–∞—Å—ã, –º–µ–∂–¥—É –ø–æ—Å–ª–µ–¥–Ω–∏–º –ø—Ä–∏—ë–º–æ–º –ø–∏—â–∏ –≤—á–µ—Ä–∞ –∏ –ø–µ—Ä–≤—ã–º —Å–µ–≥–æ–¥–Ω—è)</div>
            <span>
              –æ—Ç <input type="number" id="goalSleepMin" min="0" step="0.5" />
              –¥–æ <input type="number" id="goalSleepMax" min="0" step="0.5" />
            </span>
          </div>

          <div class="goal-row">
            <div class="subtle">–î–Ω–µ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø—Ä–∏—ë–º–∞–º–∏ –ø–∏—â–∏ (—á–∞—Å—ã, –≤ —Å—Ä–µ–¥–Ω–µ–º –∑–∞ –¥–µ–Ω—å)</div>
            <span>
              –æ—Ç <input type="number" id="goalDayIntMin" min="0" step="0.25" />
              –¥–æ <input type="number" id="goalDayIntMax" min="0" step="0.25" />
            </span>
          </div>

          <button id="saveGoalsBtn" class="btn-outline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª–∏ ‚úÖ</button>
          <p class="subtle" id="goalsStatus"></p>
        </div>
      </div>
    </div>

    <footer class="app-footer">
      EatLog ¬∑ –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –∫ –±–æ–ª–µ–µ –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ–º—É –ø–∏—Ç–∞–Ω–∏—é
    </footer>
  </div>

  <!-- FULLSCREEN –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø –î–ù–Ø -->
  <div id="detailScreen">
    <button id="btnDetailBack">
      ‚Üê –ù–∞–∑–∞–¥
    </button>
    <h2 id="detailTitle"></h2>
    <div id="detailContent"></div>
  </div>

  <script>
    const STORAGE_KEY_MEALS = 'meal_tracker_entries_v1';
    const STORAGE_KEY_GOALS = 'meal_tracker_goals_v1';

    function loadMeals() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_MEALS);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error('Failed to parse meals', e);
        return [];
      }
    }

    function saveMeals(meals) {
      localStorage.setItem(STORAGE_KEY_MEALS, JSON.stringify(meals));
    }

    function loadGoals() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_GOALS);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === 'object' ? parsed : {};
      } catch (e) {
        console.error('Failed to parse goals', e);
        return {};
      }
    }

    function saveGoals(goals) {
      localStorage.setItem(STORAGE_KEY_GOALS, JSON.stringify(goals));
    }

    let meals = loadMeals();
    let goals = loadGoals();

    const mealNoteEl = document.getElementById('mealNote');
    const addMealBtn = document.getElementById('addMealBtn');
    const mealListEl = document.getElementById('mealList');

    const statMealsTodayEl = document.getElementById('statMealsToday');
    const statSnacksTodayEl = document.getElementById('statSnacksToday');
    const statAvgIntervalEl = document.getElementById('statAvgInterval');
    const statSinceLastEl = document.getElementById('statSinceLast');
    const lastMealInfoEl = document.getElementById('lastMealInfo');

    const historyBodyEl = document.getElementById('historyBody');

    const tabTodayBtn = document.getElementById('tabToday');
    const tabStatsBtn = document.getElementById('tabStats');
    const tabGoalsBtn = document.getElementById('tabGoals');
    const viewTodayEl = document.getElementById('view-today');
    const viewStatsEl = document.getElementById('view-stats');
    const viewGoalsEl = document.getElementById('view-goals');

    const periodButtons = document.querySelectorAll('.period-btn');
    const statPeriodMealsPerDayEl = document.getElementById('statPeriodMealsPerDay');
    const statPeriodSnacksPerDayEl = document.getElementById('statPeriodSnacksPerDay');
    const statPeriodSleepIntervalEl = document.getElementById('statPeriodSleepInterval');
    const statPeriodAvgIntervalEl = document.getElementById('statPeriodAvgInterval');

    const goalMealsMinEl = document.getElementById('goalMealsMin');
    const goalMealsMaxEl = document.getElementById('goalMealsMax');
    const goalSnacksMaxEl = document.getElementById('goalSnacksMax');
    const goalSleepMinEl = document.getElementById('goalSleepMin');
    const goalSleepMaxEl = document.getElementById('goalSleepMax');
    const goalDayIntMinEl = document.getElementById('goalDayIntMin');
    const goalDayIntMaxEl = document.getElementById('goalDayIntMax');
    const saveGoalsBtn = document.getElementById('saveGoalsBtn');
    const goalsStatusEl = document.getElementById('goalsStatus');

    const detailScreen = document.getElementById('detailScreen');
    const btnDetailBack = document.getElementById('btnDetailBack');
    const detailTitle = document.getElementById('detailTitle');
    const detailContent = document.getElementById('detailContent');
    let currentDetailDayKey = null;

    let currentPeriod = '7';

    function isSameDay(ts, refDate) {
      const d1 = new Date(ts);
      const d2 = new Date(refDate);
      return d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();
    }

    function getDayKey(dateOrTs) {
      const d = dateOrTs instanceof Date ? dateOrTs : new Date(dateOrTs);
      return d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
    }

    function formatTimeHM(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatDateDMY(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit'
        // –≥–æ–¥ —É–±—Ä–∞–ª–∏, —á—Ç–æ–±—ã —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –º–µ—Å—Ç–æ
      });
    }

    function formatInterval(ms) {
      if (ms == null || isNaN(ms)) return '‚Äì';
      const totalMin = Math.floor(ms / 60000);
      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      if (h <= 0) return m + ' –º–∏–Ω';
      return h + ' —á ' + (m > 0 ? m + ' –º–∏–Ω' : '');
    }

    function formatNumberPerDay(value) {
      if (!isFinite(value)) return '0';
      const fixed = value.toFixed(1);
      if (fixed.endsWith('.0')) return fixed.slice(0, -2);
      return fixed;
    }

    function getAllMealsSorted() {
      return [...meals].sort((a, b) => a.ts - b.ts);
    }

    function getTodayMeals() {
      const now = new Date();
      return meals
        .filter(m => isSameDay(m.ts, now))
        .sort((a, b) => a.ts - b.ts);
    }

    function deleteMeal(id) {
      const entry = meals.find(m => m.id === id);
      const txt = entry ? ('¬´' + (entry.note || '').slice(0, 30) + (entry.note && entry.note.length > 30 ? '‚Ä¶' : '') + '¬ª') : '';
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏ ' + txt + '?')) return;

      meals = meals.filter(m => m.id !== id);
      saveMeals(meals);
      renderMeals();
      renderStats();
      renderPeriodSummary();
      renderHistory();
      refreshDetailIfOpen();
    }

    function editMealNote(id) {
      const entry = meals.find(m => m.id === id);
      if (!entry) return;
      const currentNote = entry.note || '';
      const updated = prompt('–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏:', currentNote);
      if (updated === null) return;
      entry.note = updated.trim();
      saveMeals(meals);
      renderMeals();
      renderHistory();
      renderPeriodSummary();
      refreshDetailIfOpen();
    }

    function editMealTime(id) {
      const entry = meals.find(m => m.id === id);
      if (!entry) return;
      const d = new Date(entry.ts);
      const currentHH = String(d.getHours()).padStart(2, '0');
      const currentMM = String(d.getMinutes()).padStart(2, '0');
      const current = currentHH + ':' + currentMM;

      const input = prompt('–ù–æ–≤–æ–µ –≤—Ä–µ–º—è (—Ñ–æ—Ä–º–∞—Ç –ß–ß:–ú–ú, 24 —á–∞—Å–∞):', current);
      if (input === null) return;

      const trimmed = input.trim();
      const match = /^([0-9]{1,2}):([0-9]{2})$/.exec(trimmed);
      if (!match) {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: 08:30 –∏–ª–∏ 22:05');
        return;
      }

      let hh = parseInt(match[1], 10);
      let mm = parseInt(match[2], 10);

      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) {
        alert('–ß–∞—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0‚Äì23, –º–∏–Ω—É—Ç—ã 0‚Äì59.');
        return;
      }

      const newDate = new Date(entry.ts);
      newDate.setHours(hh, mm, 0, 0);
      entry.ts = newDate.getTime();

      saveMeals(meals);
      renderMeals();
      renderStats();
      renderHistory();
      renderPeriodSummary();
      refreshDetailIfOpen();
    }

    function toggleSnack(id) {
      const entry = meals.find(m => m.id === id);
      if (!entry) return;
      entry.isSnack = !entry.isSnack;
      saveMeals(meals);
      renderMeals();
      renderStats();
      renderHistory();
      renderPeriodSummary();
      refreshDetailIfOpen();
    }

    function renderMeals() {
      const todayMeals = getTodayMeals();
      mealListEl.innerHTML = '';

      if (todayMeals.length === 0) {
        mealListEl.innerHTML = '<div class="subtle">–°–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ –±—ã–ª–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏. –ö–æ–≥–¥–∞ –Ω–∞—á–Ω—ë—à—å –µ—Å—Ç—å ‚Äî –Ω–∞–∂–º–∏ ¬´–Ø –µ–º —Å–µ–π—á–∞—Å¬ª.</div>';
        lastMealInfoEl.textContent = '';
        return;
      }

      const allSorted = getAllMealsSorted();
      const firstToday = todayMeals[0];
      const firstIndex = allSorted.findIndex(m => m.id === firstToday.id);

      let globalPrevTs = null;
      if (firstIndex > 0) {
        globalPrevTs = allSorted[firstIndex - 1].ts;
      }

      let prevTs = globalPrevTs;

      for (const meal of todayMeals) {
        const row = document.createElement('div');
        row.className = 'meal-row';

        const top = document.createElement('div');
        top.className = 'row-top';

        const leftWrap = document.createElement('div');
        const timeEl = document.createElement('span');
        timeEl.className = 'meal-time';
        timeEl.textContent = formatTimeHM(meal.ts);

        leftWrap.appendChild(timeEl);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const snackBtn = document.createElement('button');
        snackBtn.className = 'btn-ghost';
        snackBtn.textContent = meal.isSnack ? 'üç™' : 'üçΩ';
        snackBtn.title = meal.isSnack
          ? '–û—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø–µ—Ä–µ–∫—É—Å (–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–±—ã—á–Ω—ã–º –ø—Ä–∏—ë–º–æ–º)'
          : '–û–±—ã—á–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ (–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø–µ—Ä–µ–∫—É—Å)';
        snackBtn.onclick = () => toggleSnack(meal.id);

        const editTimeBtn = document.createElement('button');
        editTimeBtn.className = 'btn-ghost';
        editTimeBtn.textContent = '‚è∞';
        editTimeBtn.title = '–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è';
        editTimeBtn.onclick = () => editMealTime(meal.id);

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-ghost';
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ';
        editBtn.onclick = () => editMealNote(meal.id);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-danger';
        delBtn.textContent = 'üóë';
        delBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—ë–º';
        delBtn.onclick = () => deleteMeal(meal.id);

        actions.appendChild(snackBtn);
        actions.appendChild(editTimeBtn);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        top.appendChild(leftWrap);
        top.appendChild(actions);

        const noteEl = document.createElement('div');
        noteEl.className = 'meal-note';
        noteEl.textContent = meal.note || '(–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)';

        const intervalEl = document.createElement('div');
        intervalEl.className = 'meal-interval';

        if (prevTs == null) {
          intervalEl.textContent = '–ü–µ—Ä–≤—ã–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏—ë–º (—Ä–∞–Ω—å—à–µ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç).';
        } else {
          const diff = meal.ts - prevTs;
          intervalEl.textContent = '–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å –ø—Ä–æ—à–ª–æ–≥–æ –ø—Ä–∏—ë–º–∞: ' + formatInterval(diff);
        }

        prevTs = meal.ts;

        row.appendChild(top);
        row.appendChild(noteEl);
        row.appendChild(intervalEl);

        mealListEl.appendChild(row);
      }

      if (todayMeals.length > 0) {
        lastMealInfoEl.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º: ' + formatTimeHM(todayMeals[todayMeals.length - 1].ts);
      } else {
        lastMealInfoEl.textContent = '';
      }
    }

    function getTodayIntervalsWithinDay() {
      const todayMeals = getTodayMeals();
      if (todayMeals.length <= 1) return [];

      const intervals = [];
      for (let i = 1; i < todayMeals.length; i++) {
        intervals.push(todayMeals[i].ts - todayMeals[i - 1].ts);
      }
      return intervals;
    }

    function renderStats() {
      const todayMeals = getTodayMeals();
      const count = todayMeals.length;
      const snacksCount = todayMeals.filter(m => m.isSnack).length;

      statMealsTodayEl.textContent = String(count);
      statSnacksTodayEl.textContent = String(snacksCount);

      const intervals = getTodayIntervalsWithinDay();

      if (intervals.length === 0) {
        statAvgIntervalEl.textContent = '‚Äì';
      } else {
        const sum = intervals.reduce((a, b) => a + b, 0);
        const avg = sum / intervals.length;
        statAvgIntervalEl.textContent = formatInterval(avg);
      }

      if (count === 0) {
        statSinceLastEl.textContent = '‚Äì';
        lastMealInfoEl.textContent = '';
      } else {
        const last = todayMeals[todayMeals.length - 1];
        const now = Date.now();
        const diff = now - last.ts;
        statSinceLastEl.textContent = formatInterval(diff);
      }
    }

    function getSleepIntervalForDay(dayMeals, allMeals) {
      const first = dayMeals[0];
      let prev = null;
      for (const m of allMeals) {
        if (m.ts < first.ts) {
          if (!prev || m.ts > prev.ts) {
            prev = m;
          }
        }
      }
      if (!prev) return null;
      return first.ts - prev.ts;
    }

    function computeDailyStats() {
      if (meals.length === 0) return [];

      const byDayKey = {};
      for (const m of meals) {
        const dKey = getDayKey(m.ts);
        if (!byDayKey[dKey]) byDayKey[dKey] = [];
        byDayKey[dKey].push(m);
      }

      const allSorted = getAllMealsSorted();
      const result = [];

      for (const key in byDayKey) {
        const dayMeals = byDayKey[key].sort((a, b) => a.ts - b.ts);
        const count = dayMeals.length;
        const snacksCount = dayMeals.filter(m => m.isSnack).length;

        let intervals = [];
        if (count > 1) {
          for (let i = 1; i < dayMeals.length; i++) {
            intervals.push(dayMeals[i].ts - dayMeals[i - 1].ts);
          }
        }

        let avg = null;
        if (intervals.length > 0) {
          const sum = intervals.reduce((a, b) => a + b, 0);
          avg = sum / intervals.length;
        }

        const sleepInterval = getSleepIntervalForDay(dayMeals, allSorted);

        result.push({
          key,
          ts: dayMeals[0].ts,
          count,
          snacksCount,
          sleepInterval,
          avgInterval: avg
        });
      }

      result.sort((a, b) => b.ts - a.ts);
      return result;
    }

    function getFilteredDailyStats() {
      const all = computeDailyStats();
      const days = parseInt(currentPeriod, 10);
      const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
      return all.filter(d => d.ts >= cutoff);
    }

    function hasAnyGoal() {
      return (
        goals.minMealsPerDay != null ||
        goals.maxMealsPerDay != null ||
        goals.maxSnacksPerDay != null ||
        goals.minSleepHours != null ||
        goals.maxSleepHours != null ||
        goals.minDayIntervalMinutes != null ||
        goals.maxDayIntervalMinutes != null
      );
    }

    function isDayInTarget(day) {
      if (!hasAnyGoal()) return false;

      if (goals.minMealsPerDay != null && day.count < goals.minMealsPerDay) return false;
      if (goals.maxMealsPerDay != null && day.count > goals.maxMealsPerDay) return false;

      if (goals.maxSnacksPerDay != null && (day.snacksCount || 0) > goals.maxSnacksPerDay) return false;

      if (day.sleepInterval != null) {
        const sleepHours = day.sleepInterval / (60 * 60 * 1000);
        if (goals.minSleepHours != null && sleepHours < goals.minSleepHours) return false;
        if (goals.maxSleepHours != null && sleepHours > goals.maxSleepHours) return false;
      } else {
        if (goals.minSleepHours != null || goals.maxSleepHours != null) return false;
      }

      if (day.avgInterval != null) {
        const dayIntervalMinutes = day.avgInterval / 60000;
        if (goals.minDayIntervalMinutes != null && dayIntervalMinutes < goals.minDayIntervalMinutes) return false;
        if (goals.maxDayIntervalMinutes != null && dayIntervalMinutes > goals.maxDayIntervalMinutes) return false;
      } else {
        if (goals.minDayIntervalMinutes != null || goals.maxDayIntervalMinutes != null) return false;
      }

      return true;
    }

    function renderPeriodSummary() {
      const stats = getFilteredDailyStats();

      const daysCount = stats.length;
      let totalMeals = 0;
      let totalSnacks = 0;
      const sleepIntervals = [];
      const dayAvgIntervals = [];

      for (const d of stats) {
        totalMeals += d.count;
        totalSnacks += d.snacksCount || 0;
        if (d.sleepInterval != null) sleepIntervals.push(d.sleepInterval);
        if (d.avgInterval != null) dayAvgIntervals.push(d.avgInterval);
      }

      if (daysCount === 0) {
        statPeriodMealsPerDayEl.textContent = '0';
        statPeriodSnacksPerDayEl.textContent = '0';
      } else {
        const avgMealsPerDay = totalMeals / daysCount;
        const avgSnacksPerDay = totalSnacks / daysCount;
        statPeriodMealsPerDayEl.textContent = formatNumberPerDay(avgMealsPerDay);
        statPeriodSnacksPerDayEl.textContent = formatNumberPerDay(avgSnacksPerDay);
      }

      if (sleepIntervals.length === 0) {
        statPeriodSleepIntervalEl.textContent = '‚Äì';
      } else {
        const sumSleep = sleepIntervals.reduce((a, b) => a + b, 0);
        const avgSleep = sumSleep / sleepIntervals.length;
        statPeriodSleepIntervalEl.textContent = formatInterval(avgSleep);
      }

      if (dayAvgIntervals.length === 0) {
        statPeriodAvgIntervalEl.textContent = '‚Äì';
      } else {
        const sum = dayAvgIntervals.reduce((a, b) => a + b, 0);
        const avg = sum / dayAvgIntervals.length;
        statPeriodAvgIntervalEl.textContent = formatInterval(avg);
      }
    }

    function renderHistory() {
      const stats = getFilteredDailyStats();
      historyBodyEl.innerHTML = '';

      if (stats.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.className = 'subtle';
        td.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.';
        tr.appendChild(td);
        historyBodyEl.appendChild(tr);
        return;
      }

      for (const day of stats) {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';

        if (isDayInTarget(day)) {
          tr.className = 'day-ok';
        }

        tr.onclick = () => openDayDetail(day);

        const tdDate = document.createElement('td');
        tdDate.textContent = formatDateDMY(day.ts);

        const tdCount = document.createElement('td');
        tdCount.textContent = day.count;

        const tdSnacks = document.createElement('td');
        tdSnacks.textContent = day.snacksCount || 0;

        const tdSleep = document.createElement('td');
        tdSleep.textContent =
          day.sleepInterval != null ? formatInterval(day.sleepInterval) : '‚Äì';

        const tdAvg = document.createElement('td');
        tdAvg.textContent =
          day.avgInterval != null ? formatInterval(day.avgInterval) : '‚Äì';

        tr.appendChild(tdDate);
        tr.appendChild(tdCount);
        tr.appendChild(tdSnacks);
        tr.appendChild(tdSleep);
        tr.appendChild(tdAvg);

        historyBodyEl.appendChild(tr);
      }
    }

    function openDayDetail(day) {
      currentDetailDayKey = day.key;
      detailTitle.textContent = formatDateDMY(day.ts);

      const allSorted = getAllMealsSorted();
      const dayMeals = allSorted.filter(m => getDayKey(m.ts) === day.key);

      if (dayMeals.length === 0) {
        detailContent.innerHTML = '<p class="subtle">–î–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.</p>';
        detailScreen.style.display = 'block';
        return;
      }

      let html = '';
      const firstDay = dayMeals[0];
      const firstIndex = allSorted.findIndex(m => m.id === firstDay.id);
      let prevTs = null;
      if (firstIndex > 0) {
        prevTs = allSorted[firstIndex - 1].ts;
      }

      for (const meal of dayMeals) {
        const intervalText = prevTs == null
          ? '–ü–µ—Ä–≤—ã–π –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏—ë–º (—Ä–∞–Ω—å—à–µ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç).'
          : '–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å –ø—Ä–æ—à–ª–æ–≥–æ –ø—Ä–∏—ë–º–∞: ' + formatInterval(meal.ts - prevTs);

        prevTs = meal.ts;

        html += `
          <div class="meal-row">
            <div class="row-top">
              <div>
                <span class="meal-time">${formatTimeHM(meal.ts)}</span>
              </div>
              <div class="actions">
                <button class="btn-ghost"
                  title="${meal.isSnack
            ? '–û—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø–µ—Ä–µ–∫—É—Å (–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–±—ã—á–Ω—ã–º –ø—Ä–∏—ë–º–æ–º)'
            : '–û–±—ã—á–Ω—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏ (–Ω–∞–∂–º–∏, —á—Ç–æ–±—ã –æ—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø–µ—Ä–µ–∫—É—Å)'}"
                  onclick="toggleSnack('${meal.id}')">
                  ${meal.isSnack ? 'üç™' : 'üçΩ'}
                </button>
                <button class="btn-ghost" title="–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è"
                  onclick="editMealTime('${meal.id}')">‚è∞</button>
                <button class="btn-ghost" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ"
                  onclick="editMealNote('${meal.id}')">‚úèÔ∏è</button>
                <button class="btn-danger" title="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—ë–º"
                  onclick="deleteMeal('${meal.id}')">üóë</button>
              </div>
            </div>
            <div class="meal-note">${meal.note || '(–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)'}</div>
            <div class="meal-interval">${intervalText}</div>
          </div>
        `;
      }

      detailContent.innerHTML = html;
      detailScreen.style.display = 'block';
    }

    function refreshDetailIfOpen() {
      if (!currentDetailDayKey || detailScreen.style.display !== 'block') return;
      const allStats = computeDailyStats();
      const day = allStats.find(d => d.key === currentDetailDayKey);
      if (!day) {
        detailScreen.style.display = 'none';
        currentDetailDayKey = null;
        return;
      }
      openDayDetail(day);
    }

    btnDetailBack.addEventListener('click', () => {
      detailScreen.style.display = 'none';
      currentDetailDayKey = null;
    });

    function tickSinceLast() {
      renderStats();
    }

    setInterval(tickSinceLast, 60000);

    addMealBtn.addEventListener('click', () => {
      const note = (mealNoteEl.value || '').trim();
      const now = Date.now();

      const newMeal = {
        id: 'm_' + now + '_' + Math.random().toString(36).slice(2, 8),
        ts: now,
        note,
        isSnack: false
      };

      meals.push(newMeal);
      saveMeals(meals);

      mealNoteEl.value = '';

      renderMeals();
      renderStats();
      renderPeriodSummary();
      renderHistory();
      refreshDetailIfOpen();
    });

    function switchView(view) {
      if (view === 'today') {
        viewTodayEl.style.display = '';
        viewStatsEl.style.display = 'none';
        viewGoalsEl.style.display = 'none';
        tabTodayBtn.classList.add('active');
        tabStatsBtn.classList.remove('active');
        tabGoalsBtn.classList.remove('active');
      } else if (view === 'stats') {
        viewTodayEl.style.display = 'none';
        viewStatsEl.style.display = '';
        viewGoalsEl.style.display = 'none';
        tabTodayBtn.classList.remove('active');
        tabStatsBtn.classList.add('active');
        tabGoalsBtn.classList.remove('active');
      } else {
        viewTodayEl.style.display = 'none';
        viewStatsEl.style.display = 'none';
        viewGoalsEl.style.display = '';
        tabTodayBtn.classList.remove('active');
        tabStatsBtn.classList.remove('active');
        tabGoalsBtn.classList.add('active');
      }
    }

    tabTodayBtn.addEventListener('click', () => switchView('today'));
    tabStatsBtn.addEventListener('click', () => switchView('stats'));
    tabGoalsBtn.addEventListener('click', () => switchView('goals'));

    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        periodButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPeriod = btn.dataset.period;
        renderPeriodSummary();
        renderHistory();
        refreshDetailIfOpen();
      });
    });

    function loadGoalsIntoUI() {
      if (goals.minMealsPerDay != null) goalMealsMinEl.value = goals.minMealsPerDay;
      if (goals.maxMealsPerDay != null) goalMealsMaxEl.value = goals.maxMealsPerDay;
      if (goals.maxSnacksPerDay != null) goalSnacksMaxEl.value = goals.maxSnacksPerDay;
      if (goals.minSleepHours != null) goalSleepMinEl.value = goals.minSleepHours;
      if (goals.maxSleepHours != null) goalSleepMaxEl.value = goals.maxSleepHours;
      if (goals.minDayIntervalMinutes != null) goalDayIntMinEl.value = goals.minDayIntervalMinutes / 60;
      if (goals.maxDayIntervalMinutes != null) goalDayIntMaxEl.value = goals.maxDayIntervalMinutes / 60;
    }

    saveGoalsBtn.addEventListener('click', () => {
      function numOrNull(el) {
        const v = el.value.trim();
        if (!v) return null;
        const n = Number(v.replace(',', '.'));
        return isNaN(n) ? null : n;
      }

      const minMeals = numOrNull(goalMealsMinEl);
      const maxMeals = numOrNull(goalMealsMaxEl);
      const maxSnacks = numOrNull(goalSnacksMaxEl);
      const minSleepHours = numOrNull(goalSleepMinEl);
      const maxSleepHours = numOrNull(goalSleepMaxEl);
      const minDayIntHours = numOrNull(goalDayIntMinEl);
      const maxDayIntHours = numOrNull(goalDayIntMaxEl);

      goals = {
        minMealsPerDay: minMeals != null ? minMeals : null,
        maxMealsPerDay: maxMeals != null ? maxMeals : null,
        maxSnacksPerDay: maxSnacks != null ? maxSnacks : null,
        minSleepHours: minSleepHours != null ? minSleepHours : null,
        maxSleepHours: maxSleepHours != null ? maxSleepHours : null,
        minDayIntervalMinutes: minDayIntHours != null ? minDayIntHours * 60 : null,
        maxDayIntervalMinutes: maxDayIntHours != null ? maxDayIntHours * 60 : null
      };

      saveGoals(goals);
      goalsStatusEl.textContent = '–¶–µ–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ó–µ–ª—ë–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ —Å—á—ë—Ç—á–∏–∫ –¥–Ω–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω—ã.';
      renderPeriodSummary();
      renderHistory();

      setTimeout(() => {
        goalsStatusEl.textContent = '';
      }, 3000);
    });

    loadGoalsIntoUI();
    renderMeals();
    renderStats();
    renderPeriodSummary();
    renderHistory();
  </script>
</body>

</html>