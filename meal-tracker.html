<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <title>EatLog ‚Äî —Ç—Ä–µ–∫–µ—Ä –ø—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 16px;
      background: #0f172a;
      color: #e5e7eb;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }

    h2 {
      font-size: 18px;
      margin-top: 24px;
      margin-bottom: 8px;
    }

    .subtle {
      font-size: 12px;
      color: #9ca3af;
    }

    .card {
      background: #111827;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
    }

    label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
      color: #9ca3af;
    }

    textarea {
      width: 100%;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      padding: 8px 10px;
      font-size: 14px;
      margin-bottom: 10px;
      resize: vertical;
      min-height: 50px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 6px;
      margin-top: 4px;
    }

    .btn-primary {
      background: #22c55e;
      color: white;
      font-weight: 500;
    }

    .btn-primary:hover {
      background: #16a34a;
    }

    .btn-outline {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
    }

    .btn-outline:hover {
      background: #111827;
    }

    .btn-danger {
      background: transparent;
      color: #f87171;
      border: 1px solid #4b5563;
      padding: 4px 10px;
      font-size: 12px;
    }

    .btn-danger:hover {
      background: #111827;
      border-color: #f87171;
    }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid #4b5563;
      padding: 4px 10px;
      font-size: 12px;
    }

    .btn-ghost:hover {
      background: #111827;
    }

    .list {
      max-height: 360px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .meal-row {
      border-bottom: 1px solid #1f2937;
      padding: 8px 0;
      font-size: 14px;
    }

    .meal-row:last-child {
      border-bottom: none;
    }

    .row-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .meal-time {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .meal-note {
      color: #e5e7eb;
      word-break: break-word;
    }

    .meal-interval {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(52, 211, 153, 0.16);
      color: #6ee7b7;
      margin-left: 6px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat-box {
      background: #020617;
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
    }

    .stat-label {
      color: #9ca3af;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #1f2937;
    }

    th {
      font-size: 12px;
      color: #9ca3af;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      background: #020617;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .history-wrapper {
      max-height: 260px;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <h1>EatLog</h1>
  <p class="subtle">
    –ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ—à—å –µ—Å—Ç—å ‚Äî –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É. –í–≤–µ—Ä—Ö—É ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è,
    –≤–Ω–∏–∑—É ‚Äî –∏—Å—Ç–æ—Ä–∏—è –ø–æ –¥–Ω—è–º. –ó–∞–ø–∏—Å–∏ –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (—Ç–µ–∫—Å—Ç –∏ –≤—Ä–µ–º—è) –∏ —É–¥–∞–ª—è—Ç—å.
  </p>

  <div class="card">
    <h2>–ù–æ–≤—ã–π –ø—Ä–∏—ë–º –ø–∏—â–∏</h2>
    <label for="mealNote">–ß—Ç–æ —Ç—ã –µ—à—å? (–ø–æ –∂–µ–ª–∞–Ω–∏—é)</label>
    <textarea id="mealNote" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–û–≤—Å—è–Ω–∫–∞ —Å —Å–µ–º–µ—á–∫–∞–º–∏¬ª, ¬´–ß–∏–ø—Å—ã¬ª, ¬´–ß–∞–π —Å –ø–µ—á–µ–Ω—å–µ–º¬ª"></textarea>
    <button id="addMealBtn" class="btn-primary">–Ø –µ–º —Å–µ–π—á–∞—Å üçΩ</button>
    <p class="subtle" id="lastMealInfo"></p>
  </div>

  <div class="card">
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</h2>
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-label">–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</div>
        <div class="stat-value" id="statMealsToday">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</div>
        <div class="stat-value" id="statAvgInterval">‚Äì</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</div>
        <div class="stat-value" id="statMaxInterval">‚Äì</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">–°–µ–π—á–∞—Å –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ</div>
        <div class="stat-value" id="statSinceLast">‚Äì</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>–°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏</h2>
    <div class="subtle" style="margin-bottom: 6px;">–û—Ç —Ä–∞–Ω–Ω–∏—Ö –∫ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏–º. –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å—á–∏—Ç–∞–µ—Ç—Å—è –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø—Ä–∏—ë–º–∞.
    </div>
    <div class="list" id="mealList"></div>
  </div>

  <div class="card">
    <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–æ –¥–Ω—è–º</h2>
    <p class="subtle">–°–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º –¥–Ω—è–º, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞.</p>
    <div class="history-wrapper">
      <table>
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–ü—Ä–∏—ë–º–æ–≤ –ø–∏—â–∏</th>
            <th>–°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</th>
            <th>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const STORAGE_KEY_MEALS = 'meal_tracker_entries_v1';

    function loadMeals() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY_MEALS);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.error('Failed to parse meals', e);
        return [];
      }
    }

    function saveMeals(meals) {
      localStorage.setItem(STORAGE_KEY_MEALS, JSON.stringify(meals));
    }

    let meals = loadMeals();

    const mealNoteEl = document.getElementById('mealNote');
    const addMealBtn = document.getElementById('addMealBtn');
    const mealListEl = document.getElementById('mealList');

    const statMealsTodayEl = document.getElementById('statMealsToday');
    const statAvgIntervalEl = document.getElementById('statAvgInterval');
    const statMaxIntervalEl = document.getElementById('statMaxInterval');
    const statSinceLastEl = document.getElementById('statSinceLast');
    const lastMealInfoEl = document.getElementById('lastMealInfo');

    const historyBodyEl = document.getElementById('historyBody');

    function isSameDay(ts, refDate) {
      const d1 = new Date(ts);
      const d2 = new Date(refDate);
      return d1.getFullYear() === d2.getFullYear() &&
        d1.getMonth() === d2.getMonth() &&
        d1.getDate() === d2.getDate();
    }

    function formatTimeHM(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatDateDMY(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: '2-digit'
      });
    }

    function formatInterval(ms) {
      if (ms == null || isNaN(ms)) return '‚Äì';
      const totalMin = Math.floor(ms / 60000);
      const h = Math.floor(totalMin / 60);
      const m = totalMin % 60;
      if (h <= 0) return m + ' –º–∏–Ω';
      return h + ' —á ' + (m > 0 ? m + ' –º–∏–Ω' : '');
    }

    function getTodayMeals() {
      const now = new Date();
      return meals
        .filter(m => isSameDay(m.ts, now))
        .sort((a, b) => a.ts - b.ts);
    }

    function deleteMeal(id) {
      const entry = meals.find(m => m.id === id);
      const txt = entry ? ('¬´' + (entry.note || '').slice(0, 30) + (entry.note && entry.note.length > 30 ? '‚Ä¶' : '') + '¬ª') : '';
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—ë–º –ø–∏—â–∏ ' + txt + '?')) return;

      meals = meals.filter(m => m.id !== id);
      saveMeals(meals);
      renderMeals();
      renderStats();
      renderHistory();
    }

    function editMealNote(id) {
      const entry = meals.find(m => m.id === id);
      if (!entry) return;
      const currentNote = entry.note || '';
      const updated = prompt('–ò–∑–º–µ–Ω–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏:', currentNote);
      if (updated === null) return;
      entry.note = updated.trim();
      meals = meals.map(m => m.id === id ? entry : m);
      saveMeals(meals);
      renderMeals();
      renderHistory();
    }

    function editMealTime(id) {
      const entry = meals.find(m => m.id === id);
      if (!entry) return;
      const d = new Date(entry.ts);
      const currentHH = String(d.getHours()).padStart(2, '0');
      const currentMM = String(d.getMinutes()).padStart(2, '0');
      const current = currentHH + ':' + currentMM;

      const input = prompt('–ù–æ–≤–æ–µ –≤—Ä–µ–º—è (—Ñ–æ—Ä–º–∞—Ç –ß–ß:–ú–ú, 24 —á–∞—Å–∞):', current);
      if (input === null) return;

      const trimmed = input.trim();
      const match = /^([0-9]{1,2}):([0-9]{2})$/.exec(trimmed);
      if (!match) {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: 08:30 –∏–ª–∏ 22:05');
        return;
      }

      let hh = parseInt(match[1], 10);
      let mm = parseInt(match[2], 10);

      if (hh < 0 || hh > 23 || mm < 0 || mm > 59) {
        alert('–ß–∞—Å—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0‚Äì23, –º–∏–Ω—É—Ç—ã 0‚Äì59.');
        return;
      }

      const newDate = new Date(entry.ts);
      newDate.setHours(hh, mm, 0, 0);
      entry.ts = newDate.getTime();

      meals = meals.map(m => m.id === id ? entry : m);
      saveMeals(meals);
      renderMeals();
      renderStats();
      renderHistory();
    }

    function renderMeals() {
      const todayMeals = getTodayMeals();
      mealListEl.innerHTML = '';

      if (todayMeals.length === 0) {
        mealListEl.innerHTML = '<div class="subtle">–°–µ–≥–æ–¥–Ω—è –µ—â—ë –Ω–µ –±—ã–ª–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏. –ö–æ–≥–¥–∞ –Ω–∞—á–Ω—ë—à—å –µ—Å—Ç—å ‚Äî –Ω–∞–∂–º–∏ ¬´–Ø –µ–º —Å–µ–π—á–∞—Å¬ª.</div>';
        return;
      }

      let prevTs = null;
      for (const meal of todayMeals) {
        const row = document.createElement('div');
        row.className = 'meal-row';

        const top = document.createElement('div');
        top.className = 'row-top';

        const leftWrap = document.createElement('div');
        const timeEl = document.createElement('span');
        timeEl.className = 'meal-time';
        timeEl.textContent = formatTimeHM(meal.ts);

        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = '–ü—Ä–∏—ë–º –ø–∏—â–∏';

        leftWrap.appendChild(timeEl);
        leftWrap.appendChild(pill);

        const actions = document.createElement('div');
        actions.className = 'actions';

        const editTimeBtn = document.createElement('button');
        editTimeBtn.className = 'btn-ghost';
        editTimeBtn.textContent = '‚è∞';
        editTimeBtn.title = '–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è';
        editTimeBtn.onclick = () => editMealTime(meal.id);

        const editBtn = document.createElement('button');
        editBtn.className = 'btn-ghost';
        editBtn.textContent = '‚úèÔ∏è';
        editBtn.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ';
        editBtn.onclick = () => editMealNote(meal.id);

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-danger';
        delBtn.textContent = 'üóë';
        delBtn.title = '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏—ë–º';
        delBtn.onclick = () => deleteMeal(meal.id);

        actions.appendChild(editTimeBtn);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        top.appendChild(leftWrap);
        top.appendChild(actions);

        const noteEl = document.createElement('div');
        noteEl.className = 'meal-note';
        noteEl.textContent = meal.note || '(–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)';

        const intervalEl = document.createElement('div');
        intervalEl.className = 'meal-interval';

        if (prevTs == null) {
          intervalEl.textContent = '–ü–µ—Ä–≤—ã–π –ø—Ä–∏—ë–º –∑–∞ –¥–µ–Ω—å';
        } else {
          const diff = meal.ts - prevTs;
          intervalEl.textContent = '–ò–Ω—Ç–µ—Ä–≤–∞–ª —Å –ø—Ä–æ—à–ª–æ–≥–æ –ø—Ä–∏—ë–º–∞: ' + formatInterval(diff);
        }

        prevTs = meal.ts;

        row.appendChild(top);
        row.appendChild(noteEl);
        row.appendChild(intervalEl);

        mealListEl.appendChild(row);
      }

      if (todayMeals.length > 0) {
        lastMealInfoEl.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø—Ä–∏—ë–º: ' + formatTimeHM(todayMeals[todayMeals.length - 1].ts);
      } else {
        lastMealInfoEl.textContent = '';
      }
    }

    function renderStats() {
      const todayMeals = getTodayMeals();
      const count = todayMeals.length;
      statMealsTodayEl.textContent = count;

      if (count <= 1) {
        statAvgIntervalEl.textContent = '‚Äì';
        statMaxIntervalEl.textContent = '‚Äì';
      } else {
        let intervals = [];
        for (let i = 1; i < todayMeals.length; i++) {
          intervals.push(todayMeals[i].ts - todayMeals[i - 1].ts);
        }
        const sum = intervals.reduce((a, b) => a + b, 0);
        const avg = sum / intervals.length;
        const max = Math.max(...intervals);
        statAvgIntervalEl.textContent = formatInterval(avg);
        statMaxIntervalEl.textContent = formatInterval(max);
      }

      if (count === 0) {
        statSinceLastEl.textContent = '‚Äì';
        lastMealInfoEl.textContent = '';
      } else {
        const last = todayMeals[todayMeals.length - 1];
        const now = Date.now();
        const diff = now - last.ts;
        statSinceLastEl.textContent = formatInterval(diff);
      }
    }

    function computeDailyStats() {
      if (meals.length === 0) return [];

      const byDayKey = {};
      for (const m of meals) {
        const d = new Date(m.ts);
        const key = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
        if (!byDayKey[key]) {
          byDayKey[key] = [];
        }
        byDayKey[key].push(m);
      }

      const result = [];
      for (const key in byDayKey) {
        const dayMeals = byDayKey[key].sort((a, b) => a.ts - b.ts);
        const count = dayMeals.length;

        let avg = null;
        let max = null;

        if (count > 1) {
          const intervals = [];
          for (let i = 1; i < dayMeals.length; i++) {
            intervals.push(dayMeals[i].ts - dayMeals[i - 1].ts);
          }
          const sum = intervals.reduce((a, b) => a + b, 0);
          avg = sum / intervals.length;
          max = Math.max(...intervals);
        }

        result.push({
          key,
          ts: dayMeals[0].ts,
          count,
          avgInterval: avg,
          maxInterval: max
        });
      }

      result.sort((a, b) => b.ts - a.ts);
      return result;
    }

    function renderHistory() {
      const stats = computeDailyStats();
      historyBodyEl.innerHTML = '';

      if (stats.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 4;
        td.className = 'subtle';
        td.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞—á–Ω–∏ –æ—Ç–º–µ—á–∞—Ç—å –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ ‚Äî –∏—Å—Ç–æ—Ä–∏—è –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.';
        tr.appendChild(td);
        historyBodyEl.appendChild(tr);
        return;
      }

      for (const day of stats) {
        const tr = document.createElement('tr');

        const tdDate = document.createElement('td');
        tdDate.textContent = formatDateDMY(day.ts);

        const tdCount = document.createElement('td');
        tdCount.textContent = day.count;

        const tdAvg = document.createElement('td');
        tdAvg.textContent = day.count > 1 ? formatInterval(day.avgInterval) : '‚Äì';

        const tdMax = document.createElement('td');
        tdMax.textContent = day.count > 1 ? formatInterval(day.maxInterval) : '‚Äì';

        tr.appendChild(tdDate);
        tr.appendChild(tdCount);
        tr.appendChild(tdAvg);
        tr.appendChild(tdMax);

        historyBodyEl.appendChild(tr);
      }
    }

    function tickSinceLast() {
      renderStats();
    }

    setInterval(tickSinceLast, 60000);

    addMealBtn.addEventListener('click', () => {
      const note = (mealNoteEl.value || '').trim();
      const now = Date.now();

      const newMeal = {
        id: 'm_' + now + '_' + Math.random().toString(36).slice(2, 8),
        ts: now,
        note
      };

      meals.push(newMeal);
      saveMeals(meals);

      mealNoteEl.value = '';

      renderMeals();
      renderStats();
      renderHistory();
    });

    renderMeals();
    renderStats();
    renderHistory();
  </script>
</body>

</html>